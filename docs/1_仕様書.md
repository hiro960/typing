# 仕様書

気持ち良いユーザー体験の韓国語タイピング練習アプリ

---

# 技術スタック

## フロントエンド
- **Flutter** (iOS/Android対応)
  - Dart 3.x以上
  - Material Design 3 / Cupertino対応
  - **状態管理**: Riverpod / Provider
  - **API通信**: Dio / http
  - **ローカルDB**: SQLite (sqflite)
  - **セキュアストレージ**: flutter_secure_storage
  - **カスタムキーボード**: 独自実装の韓国語キーボード（ネイティブ設定不要）

## バックエンド
- **Next.js 14** (App Router)
  - **ホスティング**: Vercel
  - **ランタイム**: Node.js 18.x 以上
  - **API Routes**: RESTful API (pages/api または app/api)
  - **TypeScript**: 厳密な型チェック

## データベース
- **Neon** (Vercel統合のサーバーレスPostgreSQL)
- **ORM**: Prisma
  - マイグレーション管理
  - 型安全なクエリ
  - リレーション管理

## 認証
- **NextAuth.js v4** (Auth.js)
- **プロバイダー**:
  - Google OAuth 2.0
  - Apple Sign-In
  - Twitter/X OAuth 2.0
- **セッション**: JWT + Database Session (hybrid)
- **セキュリティ**: CSRF保護、HTTPOnly Cookie
- **UX方針**: アプリ側のUIは「ログイン / 新規登録」ボタンを1つだけ表示し、Google / Apple / X いずれかのSNSで認証する。メール・パスワードフォームは提供しない。初回ログイン時に表示名・ユーザー名・自己紹介・プロフィール画像を登録するセットアップ画面を表示し、以降はスキップ。

## リアルタイム通信
- **Pusher**: リアルタイム通知・フィード更新
  - Vercelのサーバーレス環境で完全動作
  - 無料枠で開始可能（200同時接続、200Kメッセージ/日）
  - WebSocket通信によるリアルタイム配信
  - 通知、いいね、コメント、フォローなどのイベント配信
- **代替案（高トラフィック時）**: Ably
  - より高いスケーラビリティが必要な場合に検討

## ストレージ
- **Vercel Blob**: プロフィール画像、投稿画像
  - 自動リサイズ・最適化
  - CDN配信
  - 1GB無料枠（Hobby プラン）

## その他のインフラ
- **キャッシュ**: Vercel Edge Cache + Redis (Upstash)
- **監視**: Vercel Analytics + Sentry（エラートラッキング）
- **CI/CD**: GitHub Actions + Vercel自動デプロイ

---

# UI/UX設計

**詳細は docs/2_UI.md を参照**

---

# タイピング機能の詳細仕様

**詳細は docs/4_タイピング機能.md を参照**


## レッスン構成
### 初級（子音・母音・簡単な単語）
**目標**: 基本的な子音・母音の配置を覚える

**詳細は docs/5_初級レッスン詳細.md を参照**

### 中級（簡単な単語・中級の単語）
**目標**: 日常会話でよく使う単語を素早く入力できるようになる

**詳細は docs/6_中級レッスン詳細.md を参照**

- 頻出単語300語（TOPIK I〜II レベル）
- パッチム（終声）の多い単語を重点的に練習
- 単語の意味も表示（学習効果UP）
- カテゴリー別（数字、家族、食べ物、場所、動詞、形容詞など）

### 上級（文章）
**目標**: 自然な文章を流暢に入力できるようになる

**詳細は docs/7_上級レッスン詳細.md を参照**

#### 一般文章（レッスン1〜7）
- 日常会話文（挨拶・自己紹介、日常生活）
- 短いエッセイ（私の一日、私の趣味）
- ニュース記事（天気・季節、イベント・お知らせ）
- 会話文（レストランでの注文など）

#### アイドル・推し活で使う文章（レッスン8〜14）
- SNSフレーズ（応援メッセージ、感想・コメント）
- ファンレター定型文（基本形式、感謝の気持ち）
- ファンミーティング感想
- 応援メッセージ（長文）
- 投票・支援呼びかけ
- 例: 「오늘도 수고했어요!」「사랑해요!」「최고예요!」

#### ことわざ・慣用句（レッスン15〜20）
- 韓国の有名なことわざ（努力・成功、人間関係、人生の教訓）
- 日常でよく使う慣用句（感情表現、日常表現）
- 文化的背景の説明付き
- 総復習：実践文章（自己紹介文、推し活体験記、韓国語学習の感想）

## リアルタイムフィードバック
### 文字単位フィードバック
- **入力中**: グレーのアンダーライン
- **正解**: 緑色に変化 + チェックマーク(✓)
- **不正解**: 赤色に変化 + バツマーク(✗) + 正しい文字を表示

### 単語完了時
- **完璧（ミスなし）**: 「완벽!」アニメーション + ボーナスポイント
- **良い（1〜2ミス）**: 「좋아!」表示
- **要改善（3ミス以上）**: 「다시 해보세요」+ 再挑戦提案

## 統計・分析機能
### リアルタイム統計
- **WPM（Words Per Minute）**: 1分あたりの文字数
- **正解率**: 正解文字数 / 総文字数
- **ミスタイプ数**: 訂正回数
- **所要時間**: レッスン開始からの経過時間

### 履歴・分析
- **デイリースタッツ**: 今日の練習時間・正解率
- **ウィークリーレポート**: 1週間の進捗グラフ
- **弱点分析**: ミスが多い文字・単語をハイライト

## 練習モード
### 通常モード
- 順番通りにレッスンを進める
- 合格基準（正解率80%以上）をクリアで次へ

### フリープラクティス
- 任意のレッスンを自由に選択
- 復習に最適

### カスタムレッスン
- ユーザーが自分で単語リストを作成
- 苦手な単語だけを集中練習

---

# 日記機能の詳細仕様

## コンセプト
韓国語学習者が気軽に韓国語で日記を書き、他のユーザーと交流できるSNS型の機能。
X（旧Twitter）のような手軽さと、学習支援機能を組み合わせた、学習者に優しい設計。

## 投稿機能
### 投稿作成
- **最大文字数**: 280文字（X/Twitterと同様）
- **入力支援**:
  - リアルタイム文法チェック（軽度のミスをハイライト）
  - 単語候補サジェスト（入力中にポップアップ）
  - 翻訳機能（日本語→韓国語の簡易変換）

### 画像・メディア添付
- **画像**: 最大4枚まで添付可能
- **フォーマット**: JPEG、PNG、GIF（アニメーションGIF対応）
- **圧縮**: 自動で最適化（アップロード時）

## フィード表示
### タイムライン種類
- **おすすめ**: アルゴリズムで選ばれた人気投稿
- **フォロー中**: フォローしているユーザーの投稿
- **最新**: 時系列で全ての投稿
- **ハッシュタグ**: 特定のハッシュタグの投稿のみ

### フィルタリング・検索
- **キーワード検索**: 全文検索機能
- **ユーザー検索**: ユーザー名・表示名で検索

## インタラクション機能
### いいね（좋아요 / ♥）
- ワンタップでいいね
- いいねリストの表示
- いいね数によるトレンド判定

### コメント（댓글 / 💬）
- 投稿へのコメント機能
- ネスト構造（返信の返信）には対応しない（シンプルさ優先）
- コメントにもいいね可能

### リポスト（공유 / 🔁）
- 他のユーザーの投稿を自分のフォロワーにシェア
- コメント付きリポスト可能（Quote Post）

### ブックマーク（북마크 / 🔖）
- お気に入りの投稿を保存
- プライベート機能（他のユーザーには見えない）
- フォルダ分け機能（カテゴリー別に整理）

## ユーザープロフィール
### プロフィール情報
- **ユーザー名**: @username（一意）
- **表示名**: 自由に設定
- **プロフィール画像**: アバター画像
- **自己紹介**: 最大160文字
- **学習レベル**: 初級者、中級者、上級者（自動判定または手動設定）
- **学習開始日**: アプリ登録日

## フォロー機能
- **フォロー/フォロー解除**: ワンタップで切り替え
- **フォロワー一覧**: 自分をフォローしているユーザー
- **フォロー中一覧**: 自分がフォローしているユーザー
- **相互フォロー表示**: 相互フォローのユーザーにはバッジ表示

## 通知機能
### 通知種類
- 💬 **コメント**: 自分の投稿にコメントがついた
- ❤️ **いいね**: 自分の投稿にいいねがついた
- 🔁 **リポスト**: 自分の投稿がリポストされた
- 👥 **フォロー**: 新しいフォロワーが増えた

### 通知設定
- 各通知の ON/OFF 切り替え
- プッシュ通知のタイミング設定
- 静音時間帯の設定

## モデレーション・安全機能
### 不適切コンテンツ対策
- **報告機能**: 不適切な投稿・コメント・ユーザーを報告
- **ブロック機能**: 特定ユーザーをブロック
- **ミュート機能**: 特定ユーザーの投稿を非表示

### 自動フィルタリング
- スパム検出
- 不適切な言葉の自動検知
- 連続投稿の制限（スパム防止）

## プライバシー設定
- **投稿の公開範囲**:
  - 全体公開（デフォルト）
  - フォロワーのみ
  - 自分のみ（下書き）

- **プロフィールの公開範囲**:
  - 全体公開
  - フォロワーのみ閲覧可能

## オフライン対応
- **下書き保存**: オフライン時に投稿を下書きとして保存
- **キャッシュ**: 過去の投稿をキャッシュして表示
- **同期**: オンライン復帰時に自動で下書きをアップロード

---

# 認証・ユーザー管理

## 認証方式
### SNS連携ログイン
#### Google Sign-In
- **Flutter側**: `google_sign_in` パッケージ
- **バックエンド**: NextAuth.js Google Provider
- **スコープ**: email, profile
- **利点**: 最も普及している、設定が簡単

#### Apple Sign-In
- **Flutter側**: `sign_in_with_apple` パッケージ
- **バックエンド**: NextAuth.js Apple Provider
- **必須**: iOS 13以上（App Store要件）
- **利点**: iOSユーザーに必須、プライバシー保護

#### Twitter/X OAuth
- **Flutter側**: `twitter_login` パッケージ
- **バックエンド**: NextAuth.js Twitter Provider
- **利点**: 韓国語学習者・推し活との親和性が高い

## ユーザー登録フロー
### 初回登録
```
1. 利用規約・プライバシーポリシー同意 & SNSログイン（Google / Apple / Twitter）
   ↓
2. プロフィール情報入力
   - 表示名（必須）
   - ユーザー名（@username、必須、一意）
   - 自己紹介（任意）
   - プロフィール画像（任意、デフォルトアバター）
   ↓
3. 通知設定（スキップ可能）
   ↓
4. 登録完了 → ホーム画面へ
```

### ログインフロー
```
1. ログイン画面
   ↓
2. SNSログイン（Google / Apple / Twitter）
   ↓
3. 認証成功
   ↓
4. ホーム画面へ
```

## セッション管理
**詳細は docs/3_バックエンドアーキテクチャ.md を参照**
### JWT（JSON Web Token）
- **有効期限**: 7日間
- **リフレッシュトークン**: 30日間
- **格納場所**:
  - Flutter: `flutter_secure_storage` でセキュアに保存
  - Web: HttpOnly Cookie

### セッション無効化
- ログアウト時に即座に無効化
- 不正アクセス検知時に自動無効化

## データ同期
### リアルタイム同期
- **タイピング統計**: レッスン完了時にサーバーへ送信
- **学習記録**: 毎日の練習時に更新

### オフライン対応
- **ローカルストレージ**:
  - ユーザー情報をキャッシュ
  - 統計データをローカルDB（SQLite）に保存
- **同期タイミング**:
  - アプリ起動時
  - オンライン復帰時
  - レッスン完了時

### 競合解決
- **サーバー優先**: 基本的にサーバーのデータを正とする
- **マージ**: 統計データは加算でマージ
- **タイムスタンプ**: 最新のタイムスタンプを持つデータを採用

## アカウント管理
### プロフィール編集
- **編集可能項目**:
  - 表示名（いつでも変更可能）
  - ユーザー名（30日に1回のみ変更可能）
  - 自己紹介
  - プロフィール画像
  - 学習レベル（手動設定）

### アカウント削除
- **確認フロー**:
  1. 削除の理由選択（任意）
  2. 「本当に削除しますか？」確認
  3. 削除実行

- **削除されるデータ**:
  - ユーザー情報
  - 投稿・コメント（選択可能: 削除 or 匿名化）
  - いいね・フォロー関係
  - 統計データ

- **保持されるデータ**（法的要件）:
  - アクセスログ（30日間）
  - 不正アクセス検知ログ（90日間）

### アカウント復旧
- 削除後30日間は復旧可能（soft delete）
- 30日経過後は完全削除（hard delete）

## セキュリティ対策
### 不正アクセス対策
- **レート制限**:
  - ログイン試行: 5回/10分
  - API呼び出し: 100回/分（ユーザーごと）

### データ保護
- **暗号化**:
  - 通信: HTTPS（TLS 1.3）
  - 機密データ: AES-256

- **GDPR対応**:
  - データポータビリティ（データエクスポート機能）
  - 削除権（アカウント削除機能）
  - 同意管理（Cookie同意、プライバシーポリシー同意）

### 監査ログ
- **記録対象**:
  - ログイン/ログアウト
  - プロフィール編集
  - アカウント削除

- **保持期間**: 90日間

---

# パフォーマンス要件

## アプリ起動
- **コールドスタート**: 3秒以内
- **ウォームスタート**: 1秒以内
- **スプラッシュ画面**: ブランドロゴ + プログレスバー

## 画面遷移
- **ページ遷移**: 300ms以内
- **モーダル表示**: 200ms以内
- **タブ切り替え**: 100ms以内

## タイピング入力
- **入力レスポンス**: 16ms以内（1フレーム）
- **フィードバック表示**: 100ms以内
- **正誤判定**: リアルタイム（遅延なし）

## ネットワーク
- **API応答時間**: 500ms以内（95パーセンタイル）
- **画像読み込み**: 2秒以内（プログレッシブ表示）
- **タイムアウト**: 10秒

## データベース
- **クエリ実行**: 100ms以内
- **書き込み**: 200ms以内
- **インデックス**: 主要カラムに適切なインデックス

## キャッシング戦略
### アプリ側
- **ユーザー情報**: メモリキャッシュ（セッション中）
- **レッスンデータ**: ローカルDB（SQLite）
- **画像**: ディスクキャッシュ（最大100MB）
- **API応答**: メモリキャッシュ（5分）

### サーバー側
- **CDN**: 静的アセット（画像、CSS、JS）
- **Redis**: セッション、ランキング、頻繁にアクセスされるデータ
- **有効期限**: データの性質に応じて設定（5分〜24時間）

## 最適化施策
### Flutter側
- **コード分割**: 機能ごとに遅延ロード
- **画像最適化**: WebP形式、適切な解像度
- **アニメーション**: GPU加速の活用
- **メモリ管理**: 不要なウィジェットの破棄

### バックエンド側
- **N+1問題の回避**: クエリ最適化
- **接続プーリング**: データベース接続の再利用
- **圧縮**: gzip/Brotli圧縮
- **バックグラウンド処理**: 重い処理はキューで非同期実行

---

# アクセシビリティ

## 視覚
### カラーコントラスト
- **WCAG AA準拠**: コントラスト比 4.5:1 以上
- **ダークモード**: 目に優しい配色
- **ハイコントラストモード**: オプションで提供

### 文字サイズ
- **3段階調整**: 小 / 中（デフォルト） / 大
- **スケーラブル**: システムのフォントサイズ設定に追従
- **最小サイズ**: 14px（本文）

### 色覚多様性
- **色だけに依存しない**: 形やアイコンも併用
- **色覚シミュレーション**: 開発時にテスト
- **代替表示**: 色覚異常者向けの配色モード（オプション）

## 聴覚
### サウンド
- **視覚的代替**: 音だけでなく視覚フィードバックも提供
- **字幕**: 音声ガイドがある場合は字幕提供
- **ON/OFF切り替え**: すべての音を個別に制御可能

## 運動機能
### タッチターゲット
- **最小サイズ**: 44x44px（Apple HIG準拠）
- **間隔**: ターゲット間に8px以上のスペース
- **フィードバック**: タップ時の視覚的・触覚的フィードバック

### ジェスチャー
- **代替操作**: スワイプ操作にボタンでの代替を提供
- **カスタマイズ**: ジェスチャーの感度調整

## 認知
### シンプルな操作
- **一貫性**: UI要素の配置と動作の一貫性
- **明確なラベル**: ボタンやリンクに明確なテキスト
- **エラーメッセージ**: わかりやすく具体的

### ヘルプ機能
- **チュートリアル**: 初回起動時のガイド
- **ツールチップ**: 複雑な機能の説明
- **FAQ**: よくある質問セクション

## スクリーンリーダー対応
- **Semantics**: Flutterのセマンティクス機能を活用
- **代替テキスト**: 画像・アイコンに適切なラベル
- **フォーカス順序**: 論理的な順序でナビゲーション
- **ARIA属性**: Web版でARIA属性を適切に使用

---

# 非機能要件

## 可用性
- **稼働率**: 99.5%以上（月間ダウンタイム3.6時間以内）
- **メンテナンス**: 計画的メンテナンスは事前通知
- **障害対応**: 重大障害は1時間以内に対応開始

## 拡張性
### ユーザー数
- **初期**: 〜1,000ユーザー
- **1年後**: 〜10,000ユーザー
- **3年後**: 〜100,000ユーザー

### データベース
- **スケールアップ**: 垂直スケーリング（リソース増強）
- **スケールアウト**: 水平スケーリング（レプリケーション）
- **パーティショニング**: 大規模データの分割

### サーバーレス
- **Vercel Functions**: 自動スケーリング
- **同時実行数**: Vercelのプラン上限内で管理

## 保守性
### コード品質
- **コーディング規約**: Dart/TypeScript の標準に準拠
- **Linter**: dart analyze / ESLint
- **フォーマッター**: dart format / Prettier

### テスト
- **単体テスト**: カバレッジ 70%以上
- **統合テスト**: 主要フローをカバー
- **E2Eテスト**: リリース前に実施
- **CI/CD**: GitHub Actions で自動テスト

### ドキュメント
- **API仕様書**: OpenAPI (Swagger)
- **コードコメント**: 複雑なロジックに説明
- **README**: セットアップ手順
- **変更履歴**: CHANGELOG.md

## 互換性
### OS
- **iOS**: 13.0 以上
- **Android**: 6.0 (API level 23) 以上

### ブラウザ（Web版を実装する場合）
- **Chrome**: 最新版 + 1つ前のバージョン
- **Safari**: 最新版 + 1つ前のバージョン
- **Firefox**: 最新版
- **Edge**: 最新版

### デバイス
- **スマートフォン**: iPhone SE〜iPhone 16 Pro Max、主要Android端末
- **タブレット**: iPad、Android タブレット
- **画面サイズ**: 4.7インチ 〜 12.9インチ

## 国際化（i18n）
### 対応言語
- **Phase 1**: 日本語（ja）、韓国語（ko）
- **Phase 2**: 英語（en）

### ローカライゼーション
- **日付・時刻**: ロケールに応じた表示
- **数値**: ロケールに応じた区切り文字
- **通貨**: 将来的に課金機能を実装する場合

## 法的要件
### 利用規約
- サービス利用条件の明記
- 禁止事項の明確化
- 免責事項

### プライバシーポリシー
- 収集する個人情報の種類
- 利用目的
- 第三者提供の有無
- Cookie使用の説明

### 著作権
- ユーザー投稿コンテンツの権利関係
- サービス提供者の権利

### 年齢制限
- **推奨年齢**: 12歳以上（学習アプリとして）
- **保護者の同意**: 13歳未満の場合（COPPA対応）

## バックアップ・災害対策
### データバックアップ
- **頻度**: 毎日（差分）、週次（フル）
- **保持期間**: 30日間
- **暗号化**: バックアップデータの暗号化

### 災害対策
- **データセンター**: 地理的に分散したリージョン
- **復旧時間目標（RTO）**: 4時間以内
- **復旧ポイント目標（RPO）**: 1時間以内

## モニタリング・ロギング
### 監視項目
- **サーバー**: CPU、メモリ、ディスク使用率
- **アプリケーション**: エラー率、レスポンス時間
- **ユーザー**: アクティブユーザー数、セッション時間

### ロギング
- **アプリケーションログ**: エラー、警告、情報
- **アクセスログ**: API呼び出し、ページビュー
- **監査ログ**: セキュリティ関連イベント

### アラート
- **重大障害**: 即座に通知（Slack、Email）
- **パフォーマンス低下**: 閾値超過時に通知
- **セキュリティイベント**: 不正アクセス検知時に通知

---

# 開発ロードマップ（参考）

## Phase 1: MVP（最小実行可能製品）
**期間**: 3〜4ヶ月

### タイピング機能
- ✅ 初級レッスン（レッスン1〜3）
- ✅ 基本的な入力検証
- ✅ リアルタイムフィードバック
- ✅ 統計・進捗表示

### 日記機能
- ✅ 投稿・閲覧
- ✅ いいね・コメント
- ✅ 基本的な文法ヒント

### ユーザー管理
- ✅ Google/Apple Sign-In
- ✅ プロフィール管理
- ✅ 基本統計

### デザイン
- ✅ ライトモード
- ✅ 基本アニメーション

## Phase 2: 機能拡張
**期間**: 2〜3ヶ月

### タイピング機能
- ✅ 中級・上級レッスン
- ✅ チャレンジモード
- ✅ カスタムレッスン

### 日記機能
- ✅ ハッシュタグ
- ✅ 画像添付
- ✅ フォロー機能

### デザイン
- ✅ ダークモード
- ✅ 高度なアニメーション

## Phase 3: 最適化・追加機能
**期間**: 2〜3ヶ月

### 最適化
- ✅ パフォーマンスチューニング
- ✅ オフライン対応強化
- ✅ アクセシビリティ向上

### 追加機能
- ✅ 通知機能
- ✅ 多言語対応（英語）

### 運用
- ✅ モニタリング体制
- ✅ バックアップ体制
- ✅ サポート体制

## Phase 4: 将来的な拡張（検討中）
- 📝 音声認識（発音練習）
- 📝 AIチャットボット（会話練習）
- 📝 オンライン対戦モード
- 📝 サブスクリプション（プレミアム機能）
- 📝 Web版リリース
