# 統合統計機能実装計画

## 概要

現在、レッスン統計とランキングゲーム統計は完全に分離されています。本計画では、統合統計テーブル（ActivityLog）を追加し、両方のアクティビティを統一管理することで、以下を実現します：

- **時間**: ランキングゲームのプレイ時間も累計に含める
- **日数（ストリーク）**: ランキングゲームをプレイした日もストリークに含める
- **WPM**: ランキングゲームでの入力速度もWPM統計に反映
- **正解率**: ランキングゲームでの正解率も統計に反映

---

## 現状分析

### 統計データの流れ（現状）

```
┌─────────────────┐     POST /api/lessons/complete     ┌──────────────────┐
│  タイピング練習  │ ──────────────────────────────────► │ LessonCompletion │
└─────────────────┘                                     └──────────────────┘
                                                               │
                                                               ▼
                                                        User統計更新
                                                        - totalLessonsCompleted
                                                        - maxWPM
                                                        - maxAccuracy

┌─────────────────┐     POST /api/ranking-game/results ┌──────────────────────┐
│ ランキングゲーム │ ──────────────────────────────────► │ RankingGameResult    │
└─────────────────┘                                     └──────────────────────┘
                                                               │
                                                               ▼
                                                        User統計更新
                                                        - bestRankingScore のみ
```

### 問題点

| 統計項目 | レッスン | ランキングゲーム | 問題 |
|----------|----------|------------------|------|
| 時間 | `LessonCompletion.timeSpent` | 記録なし | ランキングゲームの時間が統計に含まれない |
| ストリーク | `LessonCompletion.completedAt` から計算 | 計算されない | ランキングゲームだけの日はストリーク途切れる |
| WPM | `User.maxWPM`, `LessonCompletion.wpm` | `avgInputSpeed`（別管理） | 統合されていない |
| 正解率 | `User.maxAccuracy`, `LessonCompletion.accuracy` | 計算可能だが未統合 | ランキングゲームの正解率が統計に含まれない |

---

## 影響を受ける画面・コンポーネント

### 1. home_screen.dart（ホーム画面）

**現在の表示内容**:
- `_ProgressHero`: 今週の進捗（完了レッスン数 + 累計練習時間）
- `_StatHighlights`:
  - 正解率（過去7日平均）
  - WPM最高記録
  - **継続日数（連続記録）** ← 変更対象

**使用Provider**:
- `lessonStatsProvider` → 統合統計Providerに変更
- `myRankingStatsSummaryProvider` → 統合

**変更が必要な箇所**:
- `home_stat_highlights.dart`: ストリーク計算を統合統計から取得
- `home_progress_hero.dart`: 累計練習時間にランキングゲーム時間を含める

### 2. profile_screen.dart（プロフィール画面）

**現在の表示内容**:
- WPM平均値
- 完了レッスン数

**使用Provider**:
- `userStatsProvider` → 統合統計を返すよう変更

**変更が必要な箇所**:
- WPM平均にランキングゲームの入力速度も含めるか検討
- 「総プレイ回数」などの表示追加を検討

### 3. analysis_screen.dart（分析画面）

**現在の表示内容**:
- 苦手なキー（ヒートマップ）
- 成長推移チャート（WPM/正確率）
- **学習習慣チャート（時間帯・曜日別）** ← 変更対象
- **練習時間統計（累計・平均・日別）** ← 変更対象
- 語彙習得状況

**使用Provider**:
- `analysisDashboardProvider` → 統合統計を含めるよう変更

**変更が必要な箇所**:
- `learning_habit_chart.dart`: ランキングゲームの学習時間も含める
- `practice_time_chart.dart`: ランキングゲームの時間も含める

### 4. ranking_game関連画面

**影響**:
- `game_session_provider.dart`: ゲーム終了時にプレイ時間を計算・送信
- `ranking_game_repository.dart`: `submitGameResult`に`timeSpent`追加

---

## 実装計画

### Phase 1: データベース変更

#### 1.1 ActivityLogテーブル追加

**ファイル**: `backend/prisma/schema.prisma`

```prisma
model ActivityLog {
  id           String       @id @default(cuid())
  userId       String
  activityType ActivityType
  timeSpent    Int          // ミリ秒
  wpm          Float?       // WPM（計算可能な場合）
  accuracy     Float?       // 正確度（計算可能な場合）
  metadata     Json?        // 追加情報（lessonId, difficulty等）
  completedAt  DateTime     @default(now())

  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([userId, completedAt])
  @@index([activityType])
}

enum ActivityType {
  lesson
  ranking_game
}
```

#### 1.2 RankingGameResultにtimeSpent・accuracy追加

```prisma
model RankingGameResult {
  // 既存フィールド...
  timeSpent    Int?         // プレイ時間（ミリ秒）← 追加
  accuracy     Float?       // 正解率（0.0〜1.0）← 追加
}
```

#### 1.3 Userテーブルから不要フィールドを削除

ActivityLogから集計できるようになるため、以下のUserフィールドは**削除**します：

```prisma
model User {
  // 削除するフィールド
  // totalLessonsCompleted Int      @default(0)  ← 削除（ActivityLogからcount可能）
  // maxWPM                Float    @default(0)  ← 削除（ActivityLogからmax取得可能）
  // maxAccuracy           Float    @default(0)  ← 削除（ActivityLogからmax取得可能）
  // bestRankingScore      Int      @default(0)  ← 削除（RankingGameResultからmax取得可能）
}
```

**削除理由**:
| フィールド | 代替方法 |
|-----------|---------|
| `totalLessonsCompleted` | `ActivityLog`で`activityType='lesson'`をCOUNT |
| `maxWPM` | `ActivityLog`で`wpm`のMAXを取得 |
| `maxAccuracy` | `ActivityLog`で`accuracy`のMAXを取得 |
| `bestRankingScore` | `RankingGameResult`で`score`のMAXを取得（既存） |

**注意**: 削除前に既存データをActivityLogへ移行すること（Phase 4参照）

#### 1.4 マイグレーション

```bash
# Step 1: ActivityLog追加 + RankingGameResult修正
npx prisma migrate dev --name add_activity_log

# Step 2: データ移行後にUserフィールド削除
npx prisma migrate dev --name remove_user_stats_fields
```

---

### Phase 2: バックエンドAPI変更

#### 2.1 store.ts - ActivityLog記録関数追加

**ファイル**: `backend/src/lib/store.ts`

```typescript
// ActivityLog記録
export async function recordActivity(data: {
  userId: string;
  activityType: 'lesson' | 'ranking_game';
  timeSpent: number;
  wpm?: number;
  accuracy?: number;
  metadata?: Record<string, unknown>;
}): Promise<ActivityLog> {
  return prisma.activityLog.create({
    data: {
      userId: data.userId,
      activityType: data.activityType,
      timeSpent: data.timeSpent,
      wpm: data.wpm,
      accuracy: data.accuracy,
      metadata: data.metadata,
    },
  });
}

// 統合ストリーク計算
export async function calculateIntegratedStreak(userId: string): Promise<number> {
  const activities = await prisma.activityLog.findMany({
    where: { userId },
    select: { completedAt: true },
    orderBy: { completedAt: 'desc' },
  });

  // 日付でグループ化してストリーク計算
  const uniqueDates = [...new Set(
    activities.map(a => a.completedAt.toISOString().split('T')[0])
  )].sort().reverse();

  return calculateStreakFromDates(uniqueDates);
}

// 統合統計取得
export async function getIntegratedStats(userId: string, range: string): Promise<IntegratedStats> {
  // ActivityLogから集計
}
```

#### 2.2 lessons/complete/route.ts - 変更

**ファイル**: `backend/src/app/api/lessons/complete/route.ts`

```typescript
// 既存のLessonCompletion記録後に追加
await recordActivity({
  userId,
  activityType: 'lesson',
  timeSpent: body.timeSpent,
  wpm: body.wpm,
  accuracy: body.accuracy,
  metadata: { lessonId: body.lessonId, mode: body.mode },
});

// 以下のUser更新処理は削除
// await prisma.user.update({
//   where: { id: userId },
//   data: {
//     totalLessonsCompleted: { increment: 1 },
//     maxWPM: Math.max(currentWPM, newWPM),
//     maxAccuracy: Math.max(currentAccuracy, newAccuracy),
//   },
// });
```

#### 2.3 ranking-game/results/route.ts - 変更

**ファイル**: `backend/src/app/api/ranking-game/results/route.ts`

```typescript
// リクエストボディにtimeSpent, accuracy追加
const { timeSpent, accuracy, ...rest } = body;

// 既存のRankingGameResult記録後に追加
await recordActivity({
  userId,
  activityType: 'ranking_game',
  timeSpent,
  wpm: body.avgInputSpeed, // 入力速度をWPMとして記録
  accuracy,                // 正解率を記録
  metadata: { difficulty: body.difficulty, score: body.score },
});

// 以下のUser更新処理は削除
// await prisma.user.update({
//   where: { id: userId },
//   data: {
//     bestRankingScore: Math.max(currentBest, newScore),
//   },
// });
```

**正解率の計算方法**（フロントエンドで計算してAPIに送信）:
```typescript
// correctCount: 正解した字母数
// totalInputCount: 総入力数（正解 + ミス）
accuracy = correctCount / totalInputCount  // 0.0 ~ 1.0
```

#### 2.4 新規API: 統合統計エンドポイント

**ファイル**: `backend/src/app/api/stats/integrated/route.ts`

```typescript
// GET /api/stats/integrated?range=weekly
export async function GET(request: NextRequest) {
  const userId = await verifyAuth(request);
  const range = request.nextUrl.searchParams.get('range') || 'weekly';

  const stats = await getIntegratedStats(userId, range);
  return NextResponse.json(stats);
}
```

**レスポンス型**:
```typescript
interface IntegratedStats {
  totalTimeSpent: number;        // 累計時間（ミリ秒）
  streakDays: number;            // 連続日数
  maxWpm: number;                // 最大WPM
  avgWpm: number;                // 平均WPM
  maxAccuracy: number;           // 最大正確率
  avgAccuracy: number;           // 平均正確率
  activeDays: number;            // アクティブ日数
  breakdown: {
    lesson: {
      count: number;
      timeSpent: number;
      avgAccuracy: number;       // レッスンの平均正確率
    };
    rankingGame: {
      count: number;
      timeSpent: number;
      avgAccuracy: number;       // ランキングゲームの平均正確率
    };
  };
  dailyTrend: Array<{
    date: string;
    lessonTime: number;
    rankingGameTime: number;
    wpm: number | null;
    accuracy: number | null;
  }>;
}
```

#### 2.5 既存APIの修正

| API | 変更内容 |
|-----|---------|
| `/api/lessons/stats` | ストリークをActivityLogから計算するよう変更 |
| `/api/users/[id]/stats` | ストリークをActivityLogから計算するよう変更 |
| `/api/analysis/dashboard` | 練習時間・学習習慣にランキングゲームを含める |

---

### Phase 3: フロントエンド変更

#### 3.1 モデル追加

**ファイル**: `application/lib/features/stats/data/models/integrated_stats_model.dart`

```dart
@freezed
class IntegratedStats with _$IntegratedStats {
  const factory IntegratedStats({
    required int totalTimeSpent,
    required int streakDays,
    required double maxWpm,
    required double avgWpm,
    required double maxAccuracy,    // 最大正確率
    required double avgAccuracy,
    required int activeDays,
    required StatsBreakdown breakdown,
    required List<DailyActivityTrend> dailyTrend,
  }) = _IntegratedStats;

  factory IntegratedStats.fromJson(Map<String, dynamic> json) =>
      _$IntegratedStatsFromJson(json);
}

@freezed
class StatsBreakdown with _$StatsBreakdown {
  const factory StatsBreakdown({
    required ActivityBreakdown lesson,
    required ActivityBreakdown rankingGame,
  }) = _StatsBreakdown;

  factory StatsBreakdown.fromJson(Map<String, dynamic> json) =>
      _$StatsBreakdownFromJson(json);
}

@freezed
class ActivityBreakdown with _$ActivityBreakdown {
  const factory ActivityBreakdown({
    required int count,
    required int timeSpent,
    required double avgAccuracy,
  }) = _ActivityBreakdown;

  factory ActivityBreakdown.fromJson(Map<String, dynamic> json) =>
      _$ActivityBreakdownFromJson(json);
}
```

#### 3.2 Repository追加

**ファイル**: `application/lib/features/stats/data/repositories/integrated_stats_repository.dart`

```dart
class IntegratedStatsRepository {
  Future<IntegratedStats> fetchIntegratedStats({String range = 'weekly'}) async {
    final response = await _dio.get('/api/stats/integrated', queryParameters: {'range': range});
    return IntegratedStats.fromJson(response.data);
  }
}
```

#### 3.3 Provider追加

**ファイル**: `application/lib/features/stats/domain/providers/integrated_stats_providers.dart`

```dart
@riverpod
Future<IntegratedStats> integratedStats(Ref ref, {String range = 'weekly'}) async {
  final repository = ref.watch(integratedStatsRepositoryProvider);
  return repository.fetchIntegratedStats(range: range);
}
```

#### 3.4 game_session_provider.dart - プレイ時間・正解率計算追加

**ファイル**: `application/lib/features/ranking_game/domain/providers/game_session_provider.dart`

```dart
// ゲーム終了時にプレイ時間を計算
int get totalPlayTimeMs {
  if (_startTime == null) return 0;
  return DateTime.now().difference(_startTime!).inMilliseconds;
}

// 正解率を計算
double get accuracy {
  final totalInput = _correctCount + _mistakeCount;
  if (totalInput == 0) return 0.0;
  return _correctCount / totalInput;  // 0.0 ~ 1.0
}

// submitResult時にtimeSpentとaccuracyを含める
Future<void> submitResult() async {
  await _repository.submitGameResult(
    // 既存パラメータ...
    timeSpent: totalPlayTimeMs,  // 追加
    accuracy: accuracy,          // 追加
  );
}
```

#### 3.5 ranking_game_repository.dart - timeSpent・accuracy追加

**ファイル**: `application/lib/features/ranking_game/data/repositories/ranking_game_repository.dart`

```dart
Future<RankingGameResultResponse> submitGameResult({
  // 既存パラメータ...
  required int timeSpent,     // 追加
  required double accuracy,   // 追加
}) async {
  final response = await _dio.post('/api/ranking-game/results', data: {
    // 既存フィールド...
    'timeSpent': timeSpent,   // 追加
    'accuracy': accuracy,     // 追加
  });
  return RankingGameResultResponse.fromJson(response.data);
}
```

#### 3.6 UI変更

| ファイル | 変更内容 |
|---------|---------|
| `home_stat_highlights.dart` | `integratedStatsProvider`からストリーク取得 |
| `home_progress_hero.dart` | 累計時間を`integratedStatsProvider`から取得 |
| `practice_time_chart.dart` | ランキングゲーム時間を含めた表示 |
| `learning_habit_chart.dart` | ランキングゲームの学習時間を含める |

---

### Phase 4: データ移行（オプション）

既存の`LessonCompletion`と`RankingGameResult`からActivityLogにデータを移行：

```sql
-- LessonCompletionからActivityLogへ移行
INSERT INTO "ActivityLog" ("id", "userId", "activityType", "timeSpent", "wpm", "accuracy", "completedAt", "metadata")
SELECT
  gen_random_uuid(),
  "userId",
  'lesson',
  "timeSpent",
  "wpm",
  "accuracy",
  "completedAt",
  jsonb_build_object('lessonId', "lessonId", 'mode', "mode")
FROM "LessonCompletion";

-- RankingGameResultからActivityLogへ移行
INSERT INTO "ActivityLog" ("id", "userId", "activityType", "timeSpent", "wpm", "accuracy", "completedAt", "metadata")
SELECT
  gen_random_uuid(),
  "userId",
  'ranking_game',
  COALESCE("timeSpent", 60000),  -- デフォルト1分
  "avgInputSpeed",
  "accuracy",                     -- 正解率（既存データはNULLの可能性あり）
  "playedAt",
  jsonb_build_object('difficulty', "difficulty", 'score', "score")
FROM "RankingGameResult";
```

---

## 実装順序

```
Week 1:
├── Phase 1: データベース変更
│   ├── 1.1 ActivityLogテーブル追加
│   ├── 1.2 RankingGameResultにtimeSpent・accuracy追加
│   └── 1.4 マイグレーション実行（Step 1）

├── Phase 2: バックエンドAPI（前半）
│   ├── 2.1 store.ts - ActivityLog関数追加
│   ├── 2.2 lessons/complete - ActivityLog記録、User更新削除
│   └── 2.3 ranking-game/results - ActivityLog記録、User更新削除

Week 2:
├── Phase 2: バックエンドAPI（後半）
│   ├── 2.4 統合統計エンドポイント作成
│   └── 2.5 既存APIの修正

├── Phase 3: フロントエンド
│   ├── 3.1-3.3 モデル・Repository・Provider追加
│   ├── 3.4-3.5 ランキングゲームのtimeSpent対応
│   └── 3.6 UI変更

Week 3:
├── Phase 4: データ移行
│   └── 既存データのActivityLogへの移行

├── Phase 5: Userフィールド削除
│   ├── 1.3 Userテーブルから不要フィールド削除
│   └── 1.4 マイグレーション実行（Step 2）

└── テスト・検証
```

---

## ファイル変更一覧

### バックエンド

| ファイル | 変更種別 | 内容 |
|---------|---------|------|
| `prisma/schema.prisma` | 修正 | ActivityLog追加、RankingGameResult修正、**Userフィールド削除** |
| `src/lib/types.ts` | 修正 | IntegratedStats型追加 |
| `src/lib/store.ts` | 修正 | ActivityLog関連関数追加、**User更新ロジック削除** |
| `src/app/api/lessons/complete/route.ts` | 修正 | ActivityLog記録追加、**User更新処理削除** |
| `src/app/api/ranking-game/results/route.ts` | 修正 | timeSpent・accuracy対応、ActivityLog記録追加、**User更新処理削除** |
| `src/app/api/stats/integrated/route.ts` | 新規 | 統合統計エンドポイント |
| `src/app/api/lessons/stats/route.ts` | 修正 | ストリーク計算変更（ActivityLogベース） |
| `src/app/api/users/[id]/stats/route.ts` | 修正 | ストリーク計算変更（ActivityLogベース） |
| `src/app/api/analysis/dashboard/route.ts` | 修正 | 統合統計対応 |

### フロントエンド

| ファイル | 変更種別 | 内容 |
|---------|---------|------|
| `lib/features/stats/data/models/integrated_stats_model.dart` | 新規 | モデル定義 |
| `lib/features/stats/data/repositories/integrated_stats_repository.dart` | 新規 | Repository |
| `lib/features/stats/domain/providers/integrated_stats_providers.dart` | 新規 | Provider |
| `lib/features/ranking_game/domain/providers/game_session_provider.dart` | 修正 | timeSpent計算追加 |
| `lib/features/ranking_game/data/repositories/ranking_game_repository.dart` | 修正 | timeSpent送信対応 |
| `lib/features/ranking_game/data/models/ranking_game_models.dart` | 修正 | timeSpent追加 |
| `lib/ui/screens/home/widgets/home_stat_highlights.dart` | 修正 | 統合Provider使用 |
| `lib/ui/screens/home/widgets/home_progress_hero.dart` | 修正 | 統合Provider使用 |
| `lib/ui/screens/analysis/widgets/practice_time_chart.dart` | 修正 | 統合データ表示 |
| `lib/ui/screens/analysis/widgets/learning_habit_chart.dart` | 修正 | 統合データ表示 |

---

## リスク・注意点

1. **パフォーマンス**: ActivityLogテーブルは肥大化しやすい → インデックス設計が重要
2. **データ整合性**: 既存テーブルとActivityLogの二重管理 → トランザクションで同時更新
3. **後方互換性**: 既存APIのレスポンス形式を変えないよう注意
4. **移行データ**: RankingGameResultの既存データにはtimeSpent/accuracyがない → デフォルト値設定
5. **Userフィールド削除の順序**:
   - 必ずActivityLogへのデータ移行が完了してからUserフィールドを削除すること
   - フロントエンドがUserフィールドを直接参照している箇所がないか確認すること
   - 削除前にバックアップを取得すること

---

## 将来の拡張

- 単語帳クイズのActivityLog対応
- 日記作成のActivityLog対応
- バッジ・実績システムとの連携
- 週次/月次レポート機能
