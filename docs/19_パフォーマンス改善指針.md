# パフォーマンス改善指針（表示速度向上）

目的: 「ホーム/日記」など表示までの待ち時間を短縮するための具体的な修正案をまとめる。

## 1. 投稿フィード API の N+1 解消（最優先）
- 現状: `/api/posts` で各投稿ごとに block/follow を個別クエリ (`isBlockedFromViewer`, `isFollowingUser`)。20件で 40+ クエリ。
- 対策案:
  - `batchCheckBlocks` を活用し、block 判定を一括取得した上でフィルタリング。
  - follow 判定も `prisma.follow.findMany({ where: { followerId: viewerId, followingId: { in: authorIds } } })` にまとめ、セットで判定。
  - 可能なら Prisma の where/NOT EXISTS でブロックをクエリに取り込み、返却段階でのフィルタリングを削減。
  - レスポンス組み立ては既存の `batchGetPostInteractions` と同じ方針で「1リクエスト→1バッチ」へ寄せる。

## 2. ランキング統計の重い読み込みを分離
- 現状: ホームで `myRankingStatsProvider` を即ウォッチし、`/api/ranking-game/my-stats` が count/groupBy/複数クエリを走らせる。
- 対策案:
  - ホーム用の軽量エンドポイントを新設（例: bestScore と最近1件だけを返す）。詳細統計はランキング画面でフェッチ。
  - もしくはホームでの watch を lazy にし、ユーザー操作（カードタップ/セクション展開）時に読み込み。
  - API 側は集計を減らすかキャッシュ（期間別に計算→短時間 cache-control/kv）。

## 3. 起動時認証のタイムアウト・フォールバック
- 現状: 自動ログインがネットワーク完了まで待機。Dio の connect/receive timeout が 30s。
- 対策案:
  - Dio のタイムアウトを 8–10s 程度へ短縮 (`BaseOptions` の `connectTimeout`/`receiveTimeout`)。
  - `TokenStorageService` の期限チェックを入れ、有効なら先に「暫定ログイン済み」状態を表示しつつ非同期で検証。失敗時は未認証へダウングレード。
  - オフライン時は SecureStorage/ローカルキャッシュから last-known user を復元してスケルトン表示、API 失敗でも UI が出るようにする。

## 4. SharedPreferences/アセット読み込みの初回集中を分散
- 現状: lesson repository, progress repository, theme, typing queue などが各自 `SharedPreferences.getInstance()` を呼ぶ。ホームで writing patterns 全 JSON を即読み込み。
- 対策案:
  - `sharedPreferencesProvider` を共通化し、各 repository に注入して 1 回だけ初期化する。
  - writing patterns はセクション展開時に遅延ロード、または起動後 `addPostFrameCallback` でバックグラウンドプリロード。
  - lesson カタログ/lesson body もフォアグラウンドでは index だけ、本文は遅延/バックグラウンドプリロードに切替。

## 実装順の提案
1. フィード N+1 解消（最も効果大・広範囲）。
2. ランキング統計の軽量化/遅延読み込み。
3. 認証タイムアウト短縮とローカルフォールバック。
4. SharedPreferences/アセット読み込みの共通化と遅延。
