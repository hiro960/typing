# 日記機能実装の指摘

## Flutter（application）

1. **投稿作成UIの必須要件が実装されていない**  
   - `docs/14_日記機能の詳細_UI.md`では画像添付（最大4枚）、画像プレビュー/削除、タグ入力ショートカット、公開範囲デフォルトの自動設定、Quoteリポストを意識した`quotedPostId`指定が必須とされています。現状の`application/lib/ui/screens/post_create_screen.dart:14-234`はテキスト入力と公開範囲トグルしか持たず、画像選択・プレビューや`quotedPostId`の指定UIが存在しません。  
   - またユーザー設定の`postDefaultVisibility`を取得しておらず、常に`public`で初期化されています（同ファイル18行目）。

2. **検索/ブックマーク画面が存在せずナビゲーションにも登場しない**  
   - `docs/14_日記機能の詳細_UI.md`で新規に定義された`search_screen.dart`と`bookmarks_screen.dart`が未作成で、`_MainAppShellState`の画面配列もホーム/日記/単語帳/通知/プロフィールのみです（`application/lib/ui/shell/app_shell.dart:168-199`）。  
   - `DiaryRepository`にも`GET /api/bookmarks`を呼び出す処理がなく、ブックマーク一覧表示機能が提供されていません。

3. **通知はモックデータのみでAPI/Push連携がない**  
   - `docs/14_日記機能の詳細_機能.md`と`_API.md`ではFirebase Cloud MessagingによるPush通知と`GET /api/notifications`/既読APIが必須です。実装は`application/lib/ui/screens/notifications_screen.dart:1-126`の通り`mock_data.dart`の`notificationItems`（同ファイル85-101行目）を描画するだけで、Riverpodの状態管理やAPI呼び出しがありません。  
   - さらに`application/pubspec.yaml:31-70`には`firebase_core`/`firebase_messaging`等の依存関係が無く、FCMの受信自体が不可能です。

4. **投稿の編集・削除フローが提供されていない**  
   - 仕様では公開後24時間以内の編集/削除が求められていますが、`DiaryRepository`が持つメソッドは取得/作成/トグル操作のみで、`PUT /api/posts/{id}`や`DELETE /api/posts/{id}`を叩く関数が存在しません（`application/lib/features/diary/data/repositories/diary_repository.dart:36-210`）。  
   - `PostDetailScreen`もAppBarにリフレッシュボタンしかなく（`application/lib/ui/screens/post_detail_screen.dart:141-149`）、編集・削除・公開範囲変更のUIがありません。

5. **リポスト表示・Quote作成・ブロック/通報導線が未実装**  
   - PostCardは`post.repostInfo`をレンダリングせず、通常リポスト時に「○○さんがリポスト」などの表記が出ません（`application/lib/ui/widgets/diary_post_card.dart:25-145`）。  
   - Quoteリポスト作成用のUI/アクションも存在せず、`PostCreateScreen`から`quotedPostId`を設定することができません（同ファイル58-104行目）。  
   - `DiaryPostCard`と`PostDetailScreen`はいずれもアクション群が「いいね/コメント/リポスト/ブックマーク」だけで、仕様にある通報・ブロックボタンがありません。

6. **画像表示の最適化要件が満たされていない**  
   - 仕様では`cached_network_image`で遅延読み込み/キャッシュすることになっていますが、画像描画は`Image.network`直接呼び出しです（`application/lib/ui/widgets/diary_post_card.dart:202-235`）。  
   - `application/pubspec.yaml:31-52`にも`cached_network_image`が含まれておらず、推奨の画像最適化実装が行われていません。

## Backend（Next.js）

1. **通知APIとPush通知処理が未実装**  
   - `docs/14_日記機能の詳細_API.md`で要求されている`GET /api/notifications`/`PATCH /api/notifications/{id}/read`/`read-all`が存在せず、`backend/src/app/api`配下に`notifications`ルートはありません。  
   - Prismaでは`Notification`モデルが定義されていますが（`backend/prisma/schema.prisma:208-220`）、`store.ts`の`addLike`/`addComment`など通知を発火すべき箇所（`backend/src/lib/store.ts:510-579`）で通知レコードを作成していません。  
   - `backend/package.json`にも`firebase-admin`等が含まれておらず、FCM送信処理自体が存在しません。

2. **検索エンドポイントが無い**  
   - 要件の`GET /api/search`（全文検索・ハッシュタグ検索）に該当するルートが`backend/src/app/api`配下に無く、サービス側で検索結果を返す手段がありません。

3. **ブロック/通報APIが欠落している**  
   - Prismaには`Block`/`Report`モデルがありますが（`backend/prisma/schema.prisma:195-220`）、`store.ts`では`hasBlockingBetween`で閲覧を制御するだけで、ブロック作成/解除や通報登録の関数がありません（`backend/src/lib/store.ts:814-845`）。  
   - `/api/blocks`および`/api/reports`ルートが存在せず、仕様で求められる安全機能を提供できません。

4. **ユーザー設定・Pushトークン管理APIが未整備**  
   - 仕様にある`GET/PATCH /api/users/me/settings`および`PUT/DELETE /api/users/me/push-token`は実装されていません。  
   - 現在あるのは`/api/users/me`のGET（`backend/src/app/api/users/me/route.ts:11-24`）と`/api/users/[id]`のPUT（`backend/src/app/api/users/[id]/route.ts:1-94`）のみで、設定変更やFCMトークン更新を行うエンドポイントが欠如しています。`fcmToken`フィールドもschema以外で参照されていません（`backend/prisma/schema.prisma:40-86`と`backend/src/lib/test-utils/factories.ts:31`のみ）。

5. **画像アップロード/削除のサーバー処理が実装されていない**  
   - `docs/14_日記機能の詳細_API.md`では`POST /api/upload/image`（Vercel Blob）と投稿削除/編集時の物理削除が求められていますが、`backend/package.json`に`@vercel/blob`等の依存はなく、該当ルートも存在しません。  
   - `deletePost`はDBレコードだけを削除しており（`backend/src/lib/store.ts:483-507`）、Blobストレージ上のファイルを消す処理がありません。

6. **通知の既読API/重複防止ロジックのエンドポイントが無い**  
   - Prismaにユニーク制約を持つ`Notification`モデルが用意されているものの、既読処理のルート（`/api/notifications/{id}/read`、`/api/notifications/read-all`）が存在せず、仕様で求められる「通知の重複防止と既読管理」を提供できない状態です。
