# 日記機能実装の指摘事項

仕様書（`docs/14_日記機能の詳細.md`, `docs/14_日記機能の詳細_機能.md`）と現在の実装（Flutter/Next.js）を比較し、不足している機能、矛盾点、改善が必要な箇所をまとめました。

## 1. Backend (Next.js)

### 1.1. APIレート制限の未実装
**仕様**:
`@upstash/ratelimit` と `@vercel/kv` を使用したAPIレート制限（スパム防止）が必須とされています。
- 投稿作成: 1分間に3回
- コメント: 1分間に10回
など。

**現状**:
`backend/src/app/api/posts/route.ts` 等を確認しましたが、レート制限のロジックが含まれていません。`ERROR` ハンドリングはありますが、`Ratelimit` の実装が見当たりません。

### 1.2. HTTPメソッドの相違 (Edit)
**仕様**:
投稿編集は `PATCH /api/posts/{postId}` と定義されています。

**現状**:
`backend/src/app/api/posts/[id]/route.ts` では `PUT` メソッドとして実装されています。
実装内容自体は部分更新（Partial Update）に対応しており `PATCH` の挙動に近いですが、メソッド名が仕様と異なります。

### 1.3. オフライン/ローカル下書きの扱い
**仕様**:
「Phase 5: 拡張機能」としてオフライン対応が挙げられていますが、機能詳細には「ローカル下書き（オフライン時）」の記述があります。

**現状**:
Backendには `visibility=private` によるサーバーサイド下書き機能は実装されていますが、Frontend側でのオフライン保存や同期ロジックは未実装です（後述）。

## 2. Frontend (Flutter)

### 2.1. 下書き一覧画面の欠如
**仕様**:
「下書き一覧画面を別途用意（`/drafts` または設定画面内）」と記載されています。

**現状**:
`PostCreateScreen` で `visibility=private` （下書き）として投稿することは可能ですが、作成した下書きを確認・再編集するための専用画面（Drafts Screen）が見当たりません。
`ProfileScreen` や `DiaryScreen` からアクセスする導線がありません。

### 2.2. ハッシュタグのリアルタイム認識
**仕様**:
「UI入力時に`#`で始まる単語を自動でハッシュタグとして認識」とあり、入力中のハイライトやサジェストが示唆されています。

**現状**:
`PostCreateScreen` では、投稿送信時（`_submit`）に `_extractHashtags` で抽出するロジックになっています。入力中にリアルタイムでハッシュタグとして視覚的に認識させる機能（装飾や色付け）は実装されていません。

### 2.3. プロフィール公開範囲のUI制御
**仕様**:
「フォロワーのみ閲覧可能」の場合、フォロワー以外には投稿数やフォロー数を非表示にする仕様があります。

**現状**:
`ProfileScreen` (`application/lib/ui/screens/profile_screen.dart`) では、ユーザー情報を表示する際に `profileVisibility` 設定を確認して表示項目を制御するロジックが明示的に見当たりません（API側でデータを隠蔽している場合は `null` や `0` になる可能性がありますが、UI側で「非公開」等の表示をする対応が必要かもしれません）。

## 3. 推奨される対応

### 優先度: 高
1. **APIレート制限の実装**: セキュリティリスク軽減のため、`@upstash/ratelimit` の導入を推奨します。
2. **下書き一覧画面の作成**: ユーザーが保存した下書きにアクセスできない状態を防ぐため、プロフィール画面または設定画面からアクセスできる下書き一覧を追加してください。
3. **HTTPメソッドの修正**: API仕様書に合わせて `PUT` を `PATCH` に変更するか、仕様書を現状に合わせて修正してください。

### 優先度: 中
4. **ハッシュタグ入力体験の向上**: 入力中にハッシュタグをハイライトする機能の追加を検討してください。
5. **プロフィール非公開表示の確認**: 非公開アカウントの場合のUI表示（「このアカウントは非公開です」等の表示）が適切か再確認してください。

### 優先度: 低（将来対応）
6. **オフライン下書き**: Phase 5の予定通り、将来的な実装としてタスク管理してください。
