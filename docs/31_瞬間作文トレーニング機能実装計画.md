# 瞬間作文トレーニング機能実装計画

## 1. 概要

### 1.1 機能の目的

「瞬間作文」とは、日本語の文を見て素早く韓国語に翻訳・発話する練習方法です。**音声入力**を使用し、会話での即応力を養い、文法パターンを体に染み込ませることを目的とします。

### 1.2 学習効果

- **即応力の向上**: 日本語→韓国語の変換スピードが上がる
- **発話力の向上**: 音声入力により実際に口に出して練習できる
- **文法パターンの定着**: 繰り返し発話することで文法構造を体で覚える
- **会話力の基盤**: 瞬時に文を組み立てる力が会話力に直結する

### 1.3 既存機能との違い

| 機能 | 目的 | 入力方法 | 特徴 |
|------|------|----------|------|
| タイピング練習 | 韓国語入力の習得 | キーボード入力 | 文字・単語・文章 |
| 書き取り能力向上 | TOPIK作文対策 | キーボード入力 | テンプレート・論述 |
| **瞬間作文** | 会話の即応力 | **音声入力** | 短文・発話練習 |

---

## 2. 機能仕様

### 2.1 入力方法

#### 音声入力（メイン）
- スマートフォンの音声認識機能を使用
- 韓国語の発話を音声認識でテキスト化
- 認識結果を画面に表示

#### 手動モード（オプション）
- 音声入力をOFFにできる
- 「次へ」ボタンで手動で次の問題に進む
- 自分で声に出して確認し、正解を見て進む学習スタイル

### 2.2 出題モード

| モード | 説明 |
|--------|------|
| **順番モード** | 問題を順番通りに出題（文法の体系的学習向け） |
| **ランダムモード** | 問題をランダムに出題（復習・定着向け） |

### 2.3 正誤判定

**緩やかな判定ロジック**を採用し、発音の揺れや音声認識の誤差を許容します。

#### 判定基準
1. **完全一致**: 正解（緑で表示）
2. **ほぼ一致**（80%以上の類似度）: ほぼ正解（黄色で表示）
3. **不一致**: 不正解（赤で表示）、正解を表示

#### 許容する差異
- 句読点の有無（`.`、`?`、`!`）
- スペースの有無・数
- 助詞の微妙な揺れ（`을/를` → `를/을` の入れ替えなど）
- 語尾の丁寧さの違い（`-아요/-어요` と `-습니다` の混同は許容しない）

### 2.4 問題数と構成

- **問題数は固定10問**: 各文法項目ごとに10問を用意
- **レベル選択なし**: 項目選択で直接練習を開始
- **項目ごとの練習**: 文法辞典の項目単位で練習

### 2.5 カテゴリ構成

文法辞典（`grammar_index.json`）の全11カテゴリに準拠します。

#### カテゴリ一覧（文法辞典準拠）

| ID | カテゴリ名 | 説明 | 項目数 |
|----|------------|------|--------|
| `orthography` | 表記・発音 | ハングルの構造と発音の変化 | 22項目 |
| `substantive` | 体言 | 代名詞・数詞・疑問詞など | 51項目 |
| `particle` | 助詞 | 名詞に付いて文法的関係を示す | 25項目 |
| `conjugation` | 用言と活用 | 用言の品詞と活用パターン | 22項目 |
| `sentence_ending` | 終止形と待遇法 | 文末の終止形と待遇法 | 16項目 |
| `connective` | 接続形 | 文と文をつなぐ接続表現 | 23項目 |
| `adnominal` | 連体形 | 名詞を修飾する連体形 | 14項目 |
| `tense_aspect` | 時制 | 時制・否定・受身・使役など | 41項目 |
| `expression` | さまざまな表現 | よく使われる文法的な慣用表現 | 45項目 |
| `quotation` | 直接話法と間接話法 | 直接引用・間接引用の表現 | 11項目 |
| `word_formation` | 単語の作り | 副詞形・体言形・接辞による語形成 | 30項目 |

#### 項目構成例（助詞カテゴリ）

各カテゴリには複数の文法項目があり、それぞれに10問の瞬間作文問題を用意します。

| 項目ID | 項目名 | 説明 |
|--------|--------|------|
| `grm_particle_001` | 이/가 | 主格助詞（〜が） |
| `grm_particle_002` | 은/는 | 主題助詞（〜は） |
| `grm_particle_003` | 을/를 | 目的格助詞（〜を） |
| `grm_particle_004` | 에 | 場所・時間助詞（〜に） |
| `grm_particle_005` | 에서 | 場所助詞（〜で） |
| ... | ... | ... |

---

## 3. 画面設計

### 3.1 画面フロー

```
┌─────────────────┐
│   ホーム画面    │
│  (学習タブ)     │
└────────┬────────┘
         ↓
┌─────────────────┐
│ 瞬間作文メイン   │ ← 新規セクション
│ (カテゴリ選択)  │
└────────┬────────┘
         ↓
┌─────────────────┐
│  項目選択画面   │ ← 各文法項目を選択
│ (文法項目一覧)  │
└────────┬────────┘
         ↓
┌─────────────────┐
│  練習画面       │ ← 10問固定
│ (メイン練習)    │
└────────┬────────┘
         ↓
┌─────────────────┐
│  結果画面       │
│ (スコア・復習)  │
└─────────────────┘
```

### 3.2 メイン画面（カテゴリ選択）

```
┌─────────────────────────────────────┐
│  ← 瞬間作文トレーニング             │
├─────────────────────────────────────┤
│                                     │
│  🎤 日本語を見て韓国語で話そう      │
│                                     │
│  ─────────────────────────────────  │
│  カテゴリを選んでください           │
│  ─────────────────────────────────  │
│                                     │
│  ┌───────────────────────────────┐ │
│  │  🔤 表記・発音                 │ │
│  │  ハングルの構造と発音変化      │ │
│  │  22項目                        │ │
│  └───────────────────────────────┘ │
│                                     │
│  ┌───────────────────────────────┐ │
│  │  📖 体言                       │ │
│  │  代名詞・数詞・疑問詞          │ │
│  │  51項目                        │ │
│  └───────────────────────────────┘ │
│                                     │
│  ┌───────────────────────────────┐ │
│  │  🔗 助詞                       │ │
│  │  이/가、은/는、에、에서など     │ │
│  │  25項目                        │ │
│  └───────────────────────────────┘ │
│                                     │
│  ┌───────────────────────────────┐ │
│  │  🔄 用言と活用                 │ │
│  │  不規則活用パターン            │ │
│  │  22項目                        │ │
│  └───────────────────────────────┘ │
│                                     │
│  ┌───────────────────────────────┐ │
│  │  💬 終止形と待遇法             │ │
│  │  -아/어요、-습니다など          │ │
│  │  16項目                        │ │
│  └───────────────────────────────┘ │
│                                     │
│  ┌───────────────────────────────┐ │
│  │  🔀 接続形                     │ │
│  │  -고、-아서、-면、-지만        │ │
│  │  23項目                        │ │
│  └───────────────────────────────┘ │
│                                     │
│  ┌───────────────────────────────┐ │
│  │  📝 連体形                     │ │
│  │  名詞を修飾する形              │ │
│  │  14項目                        │ │
│  └───────────────────────────────┘ │
│                                     │
│  ┌───────────────────────────────┐ │
│  │  ⏰ 時制                       │ │
│  │  時制・否定・受身・使役        │ │
│  │  41項目                        │ │
│  └───────────────────────────────┘ │
│                                     │
│  ┌───────────────────────────────┐ │
│  │  💡 さまざまな表現             │ │
│  │  文法的な慣用表現              │ │
│  │  45項目                        │ │
│  └───────────────────────────────┘ │
│                                     │
│  ┌───────────────────────────────┐ │
│  │  💭 直接話法と間接話法         │ │
│  │  引用表現                      │ │
│  │  11項目                        │ │
│  └───────────────────────────────┘ │
│                                     │
│  ┌───────────────────────────────┐ │
│  │  📚 単語の作り                 │ │
│  │  副詞形・体言形・接辞          │ │
│  │  30項目                        │ │
│  └───────────────────────────────┘ │
│                                     │
└─────────────────────────────────────┘
```

### 3.3 項目選択画面

カテゴリを選択した後、そのカテゴリ内の文法項目一覧を表示します。

```
┌─────────────────────────────────────┐
│  ← 助詞                             │
├─────────────────────────────────────┤
│                                     │
│  ─────────────────────────────────  │
│  出題モード                         │
│  ─────────────────────────────────  │
│   [順番]  [ランダム]                │
│                                     │
│  ─────────────────────────────────  │
│  入力モード                         │
│  ─────────────────────────────────  │
│   [🎤 音声入力]  [📖 手動モード]    │
│                                     │
│  ─────────────────────────────────  │
│  項目を選んでください（各10問）     │
│  ─────────────────────────────────  │
│                                     │
│  ┌───────────────────────────────┐ │
│  │  이/가                         │ │
│  │  主格助詞（〜が）              │ │
│  │  ✓ クリア済み                  │ │
│  └───────────────────────────────┘ │
│                                     │
│  ┌───────────────────────────────┐ │
│  │  은/는                         │ │
│  │  主題助詞（〜は）              │ │
│  │  ✓ クリア済み                  │ │
│  └───────────────────────────────┘ │
│                                     │
│  ┌───────────────────────────────┐ │
│  │  을/를                         │ │
│  │  目的格助詞（〜を）            │ │
│  │  ○ 未クリア                    │ │
│  └───────────────────────────────┘ │
│                                     │
│  ┌───────────────────────────────┐ │
│  │  에                            │ │
│  │  場所・時間助詞（〜に）        │ │
│  │  ○ 未クリア                    │ │
│  └───────────────────────────────┘ │
│                                     │
│  ┌───────────────────────────────┐ │
│  │  에서                          │ │
│  │  場所助詞（〜で）              │ │
│  │  ○ 未クリア                    │ │
│  └───────────────────────────────┘ │
│                                     │
│  ┌───────────────────────────────┐ │
│  │  의                            │ │
│  │  所有格助詞（〜の）            │ │
│  │  ○ 未クリア                    │ │
│  └───────────────────────────────┘ │
│                                     │
│  ... (続く)                         │
│                                     │
└─────────────────────────────────────┘
```

### 3.4 練習画面（音声入力モード）

```
┌─────────────────────────────────────┐
│  ←                         3/10     │
│  ████████░░░░░░░░░░░░░ 30%          │
├─────────────────────────────────────┤
│                                     │
│                                     │
│         【日本語】                  │
│                                     │
│      猫がいます。                   │
│                                     │
│                                     │
│  ─────────────────────────────────  │
│                                     │
│         【韓国語で話してください】  │
│                                     │
│      ┌─────────────────────────┐   │
│      │                         │   │
│      │    고양이가 있어요.     │   │
│      │    （認識結果）         │   │
│      │                         │   │
│      └─────────────────────────┘   │
│                                     │
│      ヒント: 고양이...              │
│                                     │
│                                     │
│      ┌─────────────────────────┐   │
│      │         🎤              │   │
│      │      タップして話す     │   │
│      └─────────────────────────┘   │
│                                     │
│                                     │
│   [スキップ]       [確定 →]        │
│                                     │
└─────────────────────────────────────┘
```

### 3.5 練習画面（手動モード）

```
┌─────────────────────────────────────┐
│  ←                         3/10     │
│  ████████░░░░░░░░░░░░░ 30%          │
├─────────────────────────────────────┤
│                                     │
│                                     │
│         【日本語】                  │
│                                     │
│      猫がいます。                   │
│                                     │
│                                     │
│  ─────────────────────────────────  │
│                                     │
│         【韓国語で話してみよう】    │
│                                     │
│      声に出して練習してください     │
│                                     │
│      ヒント: 고양이...              │
│                                     │
│                                     │
│      ┌─────────────────────────┐   │
│      │      正解を見る 👁       │   │
│      └─────────────────────────┘   │
│                                     │
│                                     │
│   [戻る]           [次の問題 →]    │
│                                     │
└─────────────────────────────────────┘
```

### 3.6 正解表示（手動モード）

```
┌─────────────────────────────────────┐
│  ←                         3/10     │
│  ████████░░░░░░░░░░░░░ 30%          │
├─────────────────────────────────────┤
│                                     │
│                                     │
│         【日本語】                  │
│                                     │
│      猫がいます。                   │
│                                     │
│                                     │
│  ─────────────────────────────────  │
│                                     │
│         【正解】                    │
│                                     │
│      고양이가 있어요.               │
│                                     │
│      🔊 （タップで音声再生）        │
│                                     │
│      ─────────────────────────────  │
│      文法ポイント:                  │
│      이/가 - 主格助詞               │
│      子音で終わる名詞には「이」     │
│      母音で終わる名詞には「가」     │
│      ─────────────────────────────  │
│                                     │
│   [もう一度]       [次の問題 →]    │
│                                     │
└─────────────────────────────────────┘
```

### 3.7 正解時の表示（音声入力モード）

```
┌─────────────────────────────────────┐
│                                     │
│           ✓ 정답!                   │
│                                     │
│      고양이가 있어요.               │
│                                     │
│      🔊 （自動で音声再生）          │
│                                     │
│      ─────────────────────────────  │
│      文法ポイント:                  │
│      이/가 - 主格助詞               │
│      ─────────────────────────────  │
│                                     │
│           [次の問題 →]              │
│                                     │
└─────────────────────────────────────┘
```

### 3.8 ほぼ正解の表示

```
┌─────────────────────────────────────┐
│                                     │
│           △ 거의 맞았어요!          │
│                                     │
│      あなたの回答:                  │
│      고양이가 있어요                │
│                                     │
│      正解:                          │
│      고양이가 있어요.               │
│      ─────────                      │
│      ※ 句読点の違いのみ             │
│                                     │
│      🔊 （音声で確認）              │
│                                     │
│           [次の問題 →]              │
│                                     │
└─────────────────────────────────────┘
```

### 3.9 不正解時の表示

```
┌─────────────────────────────────────┐
│                                     │
│           ✗ 아쉬워요!               │
│                                     │
│      あなたの回答:                  │
│      고양이는 있어요.               │
│             ↓                       │
│      正解:                          │
│      고양이가 있어요.               │
│      ─────────                      │
│      ※ 은/는 と 이/가 の違い        │
│                                     │
│      🔊 （音声で確認）              │
│                                     │
│      ─────────────────────────────  │
│      文法ポイント:                  │
│      「いる」の主語には「이/가」    │
│      を使います。                   │
│      ─────────────────────────────  │
│                                     │
│   [もう一度]         [次の問題 →]   │
│                                     │
└─────────────────────────────────────┘
```

### 3.10 結果画面

```
┌─────────────────────────────────────┐
│         🎉 완료!                    │
├─────────────────────────────────────┤
│                                     │
│  ┌───────────────────────────────┐ │
│  │  📊 結果                       │ │
│  │                                │ │
│  │  正解: 8/10問 (80%)            │ │
│  │  ほぼ正解: 1問                 │ │
│  │  不正解: 1問                   │ │
│  │  総所要時間: 5分32秒           │ │
│  │                                │ │
│  └───────────────────────────────┘ │
│                                     │
│  ─────────────────────────────────  │
│  学習した文章一覧                   │
│  ─────────────────────────────────  │
│                                     │
│  ┌───────────────────────────────┐ │
│  │ ✓ 猫がいます。                 │ │
│  │   고양이가 있어요.             │ │
│  │   [🔊] [📖 文法] [＋単語帳]    │ │
│  └───────────────────────────────┘ │
│                                     │
│  ┌───────────────────────────────┐ │
│  │ ✓ 何がありますか？             │ │
│  │   뭐가 있어요?                 │ │
│  │   [🔊] [📖 文法] [＋単語帳]    │ │
│  └───────────────────────────────┘ │
│                                     │
│  ┌───────────────────────────────┐ │
│  │ ✗ 友達がいます。               │ │
│  │   친구가 있어요.               │ │
│  │   [🔊] [📖 文法] [＋単語帳]    │ │
│  └───────────────────────────────┘ │
│                                     │
│  ... (10問すべて表示)               │
│                                     │
│  ─────────────────────────────────  │
│                                     │
│  [もう一度]  [間違えた問題だけ] [終了]│
│                                     │
└─────────────────────────────────────┘

※ [📖 文法] - 該当する文法辞典の項目へ遷移
※ [＋単語帳] - 文章を単語帳に追加
```

---

## 4. データ構造

### 4.1 問題データ（JSON）

各文法項目ごとに10問の問題を用意します。ファイルは `grammar_index.json` の項目IDに対応させます。

```json
{
  "grammarRef": "grm_particle_001",
  "grammarTitle": "이/가",
  "grammarSubtitle": "主格助詞（〜が）",
  "category": "particle",
  "questions": [
    {
      "id": "qt_particle_001_01",
      "order": 1,
      "japanese": "猫がいます。",
      "korean": "고양이가 있어요.",
      "alternativeAnswers": ["고양이가 있습니다."],
      "hint": "고양이...",
      "explanation": "子音で終わる名詞には「이」、母音で終わる名詞には「가」を使います。"
    },
    {
      "id": "qt_particle_001_02",
      "order": 2,
      "japanese": "何がありますか？",
      "korean": "뭐가 있어요?",
      "alternativeAnswers": ["무엇이 있어요?", "뭐가 있습니까?"],
      "hint": "뭐가...",
      "explanation": "「뭐」は母音で終わるので「가」を使います。"
    },
    // ... 合計10問
  ]
}
```

### 4.2 フィールド説明

| フィールド | 型 | 必須 | 説明 |
|------------|-----|------|------|
| `grammarRef` | String | ✓ | 文法辞典の項目ID（`grm_particle_001`など） |
| `grammarTitle` | String | ✓ | 文法項目のタイトル（韓国語） |
| `grammarSubtitle` | String | ✓ | 文法項目のサブタイトル（日本語説明） |
| `category` | String | ✓ | 文法カテゴリID |
| `questions` | Array | ✓ | 問題リスト（10問） |
| `questions[].id` | String | ✓ | 問題の一意識別子 |
| `questions[].order` | Int | ✓ | 問題の順番（1〜10） |
| `questions[].japanese` | String | ✓ | 日本語の問題文 |
| `questions[].korean` | String | ✓ | 正解の韓国語 |
| `questions[].alternativeAnswers` | Array | - | 別解（複数の正解がある場合） |
| `questions[].hint` | String | - | ヒント（最初の数文字など） |
| `questions[].explanation` | String | - | 解説（不正解時に表示） |

### 4.3 カテゴリ・項目定義

カテゴリ・項目定義は既存の `grammar_index.json` を直接参照します。新規の定義ファイルは作成しません。

### 4.4 ユーザー進捗データ

```dart
/// 瞬間作文の練習記録
@freezed
class QuickTranslationRecord with _$QuickTranslationRecord {
  const factory QuickTranslationRecord({
    required String id,
    required String questionId,
    required AnswerResult result,       // correct / almostCorrect / incorrect
    required String userAnswer,         // ユーザーの回答
    required DateTime attemptedAt,
  }) = _QuickTranslationRecord;
}

/// 回答結果
enum AnswerResult {
  correct,        // 正解
  almostCorrect,  // ほぼ正解（80%以上の類似度）
  incorrect,      // 不正解
  skipped,        // スキップ
}

/// 項目別の進捗（各文法項目ごと）
@freezed
class GrammarItemProgress with _$GrammarItemProgress {
  const factory GrammarItemProgress({
    required String grammarRef,         // 文法項目ID（grm_particle_001など）
    required bool isCleared,            // 10問中8問以上正解でクリア
    required int bestCorrectCount,      // 最高正解数
    required DateTime? lastPracticedAt, // 最終練習日時
  }) = _GrammarItemProgress;
}

/// 練習セッション
@freezed
class PracticeSession with _$PracticeSession {
  const factory PracticeSession({
    required String sessionId,
    required String grammarRef,         // 文法項目ID
    required String categoryId,         // カテゴリID
    required PracticeMode mode,
    required InputMode inputMode,
    required List<QuickTranslationRecord> records,
    required int totalTimeMs,
    required DateTime startedAt,
    required DateTime? completedAt,
  }) = _PracticeSession;
}

/// 出題モード
enum PracticeMode {
  sequential,    // 順番
  random,        // ランダム
}

/// 入力モード
enum InputMode {
  voice,    // 音声入力
  manual,   // 手動モード
}
```

---

## 5. 正解判定ロジック

### 5.1 基本方針

- **緩やかな判定**を採用し、発音の揺れや音声認識の誤差を許容
- 類似度80%以上は「ほぼ正解」として扱う

### 5.2 正規化処理

```dart
String normalizeAnswer(String answer) {
  return answer
    .trim()                           // 前後の空白を除去
    .replaceAll(RegExp(r'\s+'), ' ')  // 連続空白を1つに
    .replaceAll('．', '.')            // 全角句点を半角に
    .replaceAll('。', '.')            // 日本語句点を統一
    .replaceAll('？', '?')            // 全角疑問符を半角に
    .replaceAll('！', '!')            // 全角感嘆符を半角に
    .toLowerCase()                    // 小文字化（英字混在時）
    ;
}

String removePunctuation(String text) {
  return text.replaceAll(RegExp(r'[.?!,]'), '');
}
```

### 5.3 類似度計算

```dart
/// Levenshtein距離を使用した類似度計算
double calculateSimilarity(String s1, String s2) {
  if (s1.isEmpty && s2.isEmpty) return 1.0;
  if (s1.isEmpty || s2.isEmpty) return 0.0;

  final distance = levenshteinDistance(s1, s2);
  final maxLength = max(s1.length, s2.length);
  return 1.0 - (distance / maxLength);
}
```

### 5.4 判定フロー

```dart
AnswerResult checkAnswer(String userAnswer, Question question) {
  final normalized = normalizeAnswer(userAnswer);
  final correctNormalized = normalizeAnswer(question.korean);

  // 1. 完全一致チェック
  if (normalized == correctNormalized) {
    return AnswerResult.correct;
  }

  // 2. 別解チェック
  for (final alt in question.alternativeAnswers) {
    if (normalized == normalizeAnswer(alt)) {
      return AnswerResult.correct;
    }
  }

  // 3. 句読点を除いて完全一致チェック
  final noPunc = removePunctuation(normalized);
  final correctNoPunc = removePunctuation(correctNormalized);
  if (noPunc == correctNoPunc) {
    return AnswerResult.correct; // 句読点の違いは正解扱い
  }

  // 4. 類似度チェック（80%以上でほぼ正解）
  final similarity = calculateSimilarity(noPunc, correctNoPunc);
  if (similarity >= 0.8) {
    return AnswerResult.almostCorrect;
  }

  // 5. 別解との類似度チェック
  for (final alt in question.alternativeAnswers) {
    final altNoPunc = removePunctuation(normalizeAnswer(alt));
    if (calculateSimilarity(noPunc, altNoPunc) >= 0.8) {
      return AnswerResult.almostCorrect;
    }
  }

  // 6. 不正解
  return AnswerResult.incorrect;
}
```

---

## 6. ファイル構成

### 6.1 新規作成ファイル

```
application/lib/
├── features/quick_translation/
│   ├── data/
│   │   ├── models/
│   │   │   ├── quick_translation_question.dart     # 問題モデル
│   │   │   ├── grammar_item_progress.dart          # 項目別進捗モデル
│   │   │   ├── quick_translation_record.dart       # 練習記録モデル
│   │   │   └── practice_session.dart               # セッションモデル
│   │   ├── repositories/
│   │   │   ├── quick_translation_repository.dart   # 問題データ取得
│   │   │   └── practice_record_repository.dart     # 練習記録の永続化
│   │   └── services/
│   │       ├── answer_checker_service.dart         # 正解判定サービス
│   │       └── speech_recognition_service.dart     # 音声認識サービス
│   ├── domain/
│   │   └── providers/
│   │       ├── quick_translation_providers.dart    # メインプロバイダー
│   │       └── quick_translation_providers.g.dart
│   └── presentation/
│       └── widgets/
│           └── quick_translation_section.dart      # ホーム画面用セクション
│
├── ui/screens/quick_translation/
│   ├── quick_translation_home_screen.dart          # メイン画面（カテゴリ選択）
│   ├── grammar_item_list_screen.dart               # 項目選択画面
│   ├── practice_screen.dart                        # 練習画面（メイン）
│   ├── practice_result_screen.dart                 # 結果画面
│   └── widgets/
│       ├── question_card.dart                      # 問題表示カード
│       ├── voice_input_button.dart                 # 音声入力ボタン
│       ├── recognition_result_display.dart         # 認識結果表示
│       ├── feedback_overlay.dart                   # 正解/不正解オーバーレイ
│       ├── answer_reveal_card.dart                 # 正解表示カード（手動モード）
│       └── progress_indicator.dart                 # 進捗インジケーター
│
application/assets/quick_translation/
├── orthography/                                    # 表記・発音（22項目×10問＝220問）
│   ├── grm_orthography_001.json                    # 한글의 구조
│   ├── grm_orthography_002.json                    # 단모음
│   ├── grm_orthography_003.json                    # 반모음
│   └── ... (grm_orthography_022.json まで)
├── substantive/                                    # 体言（51項目×10問＝510問）
│   ├── grm_substantive_001.json                    # 나/저
│   ├── grm_substantive_002.json                    # 너/당신
│   └── ... (grm_substantive_051.json まで)
├── particle/                                       # 助詞（25項目×10問＝250問）
│   ├── grm_particle_001.json                       # 이/가
│   ├── grm_particle_002.json                       # 은/는
│   └── ... (grm_particle_025.json まで)
├── conjugation/                                    # 用言と活用（22項目×10問＝220問）
│   └── ... (grm_conjugation_001.json 〜 022.json)
├── sentence_ending/                                # 終止形と待遇法（16項目×10問＝160問）
│   └── ... (grm_sentence_ending_001.json 〜 016.json)
├── connective/                                     # 接続形（23項目×10問＝230問）
│   └── ... (grm_connective_001.json 〜 023.json)
├── adnominal/                                      # 連体形（14項目×10問＝140問）
│   └── ... (grm_adnominal_001.json 〜 014.json)
├── tense_aspect/                                   # 時制（41項目×10問＝410問）
│   └── ... (grm_tense_aspect_001.json 〜 041.json)
├── expression/                                     # さまざまな表現（45項目×10問＝450問）
│   └── ... (grm_expression_001.json 〜 045.json)
├── quotation/                                      # 直接話法と間接話法（11項目×10問＝110問）
│   └── ... (grm_quotation_001.json 〜 011.json)
└── word_formation/                                 # 単語の作り（30項目×10問＝300問）
    └── ... (grm_word_formation_001.json 〜 030.json)

# 総問題数: 300項目 × 10問 = 3,000問
```

### 6.2 既存ファイル修正

```
application/lib/ui/screens/home/
└── home_learning_tabs.dart                         # QuickTranslationSection追加
```

---

## 7. 実装手順

### Phase 1: データ基盤

1. **モデル作成**
   - `QuickTranslationQuestion` - 問題モデル
   - `GrammarItemProgress` - 項目別進捗モデル
   - `QuickTranslationRecord` - 練習記録モデル
   - `PracticeSession` - セッションモデル

2. **問題データ作成**
   - 各文法項目ごとに10問の問題JSONを作成
   - 優先度の高いカテゴリ（助詞、終止形、接続形）から作成開始
   - grammar_index.json の項目IDに対応したファイル名

3. **リポジトリ作成**
   - 問題データの読み込み（grammar_index.jsonと問題JSONの連携）
   - 練習記録の永続化（SharedPreferences）

### Phase 2: 状態管理

4. **プロバイダー作成**
   - `quickTranslationQuestionsProvider` - 問題リスト管理
   - `grammarCategoriesProvider` - grammar_index.jsonからカテゴリ取得
   - `grammarItemsProvider` - カテゴリ内の項目一覧取得
   - `practiceSessionProvider` - 練習セッション管理
   - `grammarItemProgressProvider` - 項目別進捗管理

### Phase 3: 音声認識

5. **音声認識サービス**
   - `speech_to_text` パッケージの導入
   - 韓国語音声認識の設定
   - 認識結果のコールバック処理

6. **正解判定サービス**
   - 正規化処理
   - 類似度計算
   - 判定ロジック

### Phase 4: UI実装

7. **メイン画面** (`quick_translation_home_screen.dart`)
   - カテゴリ選択リスト（全11カテゴリ）
   - 各カテゴリの項目数表示

8. **項目選択画面** (`grammar_item_list_screen.dart`)
   - 選択したカテゴリ内の文法項目一覧
   - クリア状況の表示（✓/○）
   - 出題モード選択（順番/ランダム）
   - 入力モード選択（音声入力/手動モード）

9. **練習画面** (`practice_screen.dart`)
   - 問題表示
   - 音声入力ボタン
   - 認識結果表示
   - 手動モード対応（正解表示ボタン、次へボタン）
   - 進捗表示
   - 正解/ほぼ正解/不正解フィードバック

10. **結果画面** (`practice_result_screen.dart`)
    - スコア表示（正解/ほぼ正解/不正解）
    - 間違えた問題一覧
    - 復習オプション

### Phase 5: 統合

11. **ホーム画面への統合**
    - `QuickTranslationSection`ウィジェット作成
    - `home_learning_tabs.dart`に追加
    - ナビゲーション設定

12. **音声再生機能統合**
    - 既存の`wordAudioServiceProvider`を活用
    - 正解時の自動再生

---

## 8. UI/UX設計詳細

### 8.1 アニメーション

| 場面 | アニメーション | 時間 |
|------|----------------|------|
| 問題表示 | フェードイン | 200ms |
| 音声入力中 | パルスアニメーション | 継続 |
| 正解時 | 緑色パルス + チェックマーク | 300ms |
| ほぼ正解時 | 緑色パルス + チェックマーク | 300ms |
| 不正解時 | 赤色シェイク | 300ms |
| 次の問題へ | スライド | 250ms |

### 8.2 カラースキーム

- 正解: `AppColors.success` (緑系)
- ほぼ正解: `AppColors.warning` (黄系)
- 不正解: `AppColors.error` (赤系)
- ヒント: `AppColors.secondary` (グレー系)
- 進捗バー: `AppColors.primary`

### 8.3 音声フィードバック

- 正解時: 正解の韓国語を自動再生
- ほぼ正解時: 正解の韓国語を自動再生
- 不正解時: タップで再生可能
- 設定でON/OFF可能

### 8.4 触覚フィードバック

- 正解時: 軽い振動
- 不正解時: 強めの振動
- 設定でON/OFF可能

---

## 9. データの永続化

### 9.1 SharedPreferencesキー設計

```dart
// 練習記録
static const practiceRecordsKey = 'quick_translation_records';

// カテゴリ別進捗
static const categoryProgressKey = 'quick_translation_category_progress';

// 統計
static const statsKey = 'quick_translation_stats';

// 設定
static const settingsKey = 'quick_translation_settings';
```

### 9.2 保存形式

```json
// 練習記録（最新100件を保持）
{
  "records": [
    {
      "id": "rec_001",
      "questionId": "qt_particle_001_01",
      "result": "correct",
      "userAnswer": "고양이가 있어요.",
      "attemptedAt": "2024-03-15T10:30:00Z"
    }
  ]
}

// カテゴリ別進捗
{
  "particle": {
    "totalQuestions": 25,
    "completedQuestions": 15,
    "correctCount": 12,
    "almostCorrectCount": 2,
    "lastPracticedAt": "2024-03-15T10:30:00Z"
  }
}

// 統計
{
  "totalPracticeCount": 128,
  "totalCorrectCount": 102,
  "totalAlmostCorrectCount": 15,
  "averageAccuracy": 0.78,
  "totalPracticeTimeMs": 3600000
}

// 設定
{
  "inputMode": "voice",
  "practiceMode": "sequential",
  "playAudioOnCorrect": true,
  "showHint": true
}
```

---

## 10. 必要なパッケージ

```yaml
dependencies:
  # 音声認識
  speech_to_text: ^6.6.0

  # 権限管理
  permission_handler: ^11.0.0
```

--

### 11.1 長期的な拡張

- **パーソナライズ**: ユーザーの苦手パターンを分析し、最適な問題を出題
- **コミュニティ問題**: ユーザーが問題を作成・共有
- **TOPIK対策連携**: 書き取り能力向上機能との統合

---

## 12. 参考

### 既存実装の参照

- **音声再生**: `application/lib/features/wordbook/domain/providers/wordbook_providers.dart`
  - `wordAudioServiceProvider` - 韓国語TTS音声再生サービス
- **タイピング機能**: `application/lib/features/typing_lesson/`
- **漢字語クイズ**: `application/lib/features/hanja_quiz/`

### 関連ドキュメント

- [11_タイピング機能の詳細.md](./11_タイピング機能の詳細.md)
- [13_単語クイズ機能の詳細.md](./13_単語クイズ機能の詳細.md)
- [17_書き取り能力向上機能.md](./17_書き取り能力向上機能.md)
- [21_文法辞典機能の詳細.md](./21_文法辞典機能の詳細.md)
- [30_漢字語クイズゲーム実装計画.md](./30_漢字語クイズゲーム実装計画.md)

### 文法辞典との連携

瞬間作文機能は文法辞典（`grammar_index.json`）と連携し、以下のメリットを提供します：

1. **統一されたカテゴリ**: 文法辞典と同じ11カテゴリ構造を使用し、学習の一貫性を確保
2. **相互リンク**: 不正解時に関連する文法項目へのリンクを表示可能
3. **文法項目別の練習**: 特定の文法項目（例: `grm_particle_001` - 이/가）に関連する問題だけを集中練習
4. **進捗の共有**: 文法辞典の学習進捗と瞬間作文の練習進捗を統合表示
