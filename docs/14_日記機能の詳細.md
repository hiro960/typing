# 日記機能の詳細仕様

韓国語学習者が気軽に韓国語で日記を書き、他のユーザーと交流できるSNS型の機能。X（旧Twitter）のような手軽さと、学習支援機能を組み合わせた、学習者に優しい設計。

## 📚 ドキュメント構成

このドキュメントは以下の4つのセクションに分割されています。各セクションの詳細は、以下のリンクから確認してください。

### 1. [機能仕様](./14_日記機能の詳細_機能.md)
日記機能全体のコンセプト、ユーザープロフィール、投稿作成・編集機能、インタラクション機能（いいね、コメント、リポスト、ブックマーク）、通知機能、プライバシー設定などの詳細仕様を記載しています。

**主な内容:**
- コンセプトと機能概要
- 投稿作成・編集・削除の仕様
  - 画像添付（最大4枚）
  - ハッシュタグ対応
  - 公開範囲設定（public/followers/private）
  - 投稿編集（24時間以内）
- インタラクション機能
  - いいね機能
  - コメント機能（削除権限: 投稿者のみ）
  - リポスト機能（通常のリポスト + Quote リポスト）
  - ブックマーク機能
- 通知機能
  - プッシュ通知（Firebase Cloud Messaging）
  - 通知の重複防止ロジック
- プライバシーとセキュリティ
  - ブロック機能
  - 報告機能
  - アクセス制御

### 2. [DB設計](./14_日記機能の詳細_DB.md)
データモデル設計、Prismaスキーマ定義、リレーション、カスケード削除ポリシーなどを記載しています。

**主な内容:**
- 既存モデルの拡張
  - User（fcmToken, settings追加）
  - Post（quotedPostId, repostsCount, quotesCount追加）
  - Comment（likesCount, updatedAt追加）
- 新規モデル
  - Repost（通常のリポスト管理）
  - Bookmark（ブックマーク管理）
  - Notification（通知管理、重複防止のユニーク制約）
  - CommentLike（コメントへのいいね）
  - Report（報告機能）
  - Block（ブロック機能）
- カスケード削除ポリシー
  - 投稿削除時の関連データ処理
  - コメント削除時の関連データ処理
  - 画像削除ポリシー（Vercel Blob Storage）

### 3. [API設計](./14_日記機能の詳細_API.md)
RESTful APIエンドポイントの詳細仕様、リクエスト・レスポンス形式、アクセス制御、エラーハンドリングなどを記載しています。

**主な内容:**
- 既存エンドポイント（実装済み）
  - GET /api/posts（フィード取得）
  - GET /api/posts/{postId}（投稿単体取得）
  - POST /api/posts（投稿作成）
  - PATCH /api/posts/{postId}（投稿編集）
  - DELETE /api/posts/{postId}（投稿削除）
  - フォロー関係・ユーザー取得
- 新規エンドポイント（追加が必要）
  - いいね機能（POST/DELETE /api/posts/{postId}/like）
  - コメント機能（GET/POST /api/posts/{postId}/comments, DELETE /api/comments/{commentId}）
  - リポスト機能（POST/DELETE /api/posts/{postId}/repost）
  - ブックマーク機能（POST/DELETE /api/posts/{postId}/bookmark, GET /api/bookmarks）
  - 通知機能（GET /api/notifications, PATCH /api/notifications/{id}/read）
  - 報告・ブロック機能（POST /api/reports, POST/DELETE /api/blocks）
  - 検索機能（GET /api/search）
  - 画像アップロード（POST /api/upload/image）
  - ユーザー設定（GET/PATCH /api/users/me/settings）
  - FCMトークン管理（PUT/DELETE /api/users/me/push-token）

### 4. [UI/UX設計](./14_日記機能の詳細_UI.md)
Flutter画面構成、再利用可能なウィジェット、デザインシステム、実装上の注意点などを記載しています。

**主な内容:**
- 画面構成
  - 日記タイムライン画面（diary_screen.dart）
  - 投稿作成画面（post_create_screen.dart）※新規作成必要
  - 投稿ディテール画面（post_detail_screen.dart）※新規作成必要
  - ユーザープロフィール画面（profile_screen.dart）※既存
  - 通知画面（notifications_screen.dart）※新規作成必要
  - 検索画面（search_screen.dart）※新規作成必要
  - ブックマーク画面（bookmarks_screen.dart）※新規作成必要
- 再利用可能なウィジェット
  - PostCard（投稿カード）
  - CommentCard（コメントカード）
  - UserAvatar（ユーザーアバター）
  - ActionButton（アクションボタン）
  - ImageGrid（画像グリッド）
  - HashtagChip（ハッシュタグチップ）
- デザインシステム
  - カラーパレット
  - タイポグラフィ
  - スペーシング
  - アニメーション
- 実装上の指摘事項・懸念点
  - 画像アップロード実装（Vercel Blob Storage）
  - おすすめフィードのアルゴリズム
  - 全文検索実装（PostgreSQL pg_trgm拡張）
  - リポスト表示の仕様
  - 通知実装（Firebase Cloud Messaging）
  - ブロック機能の詳細
  - オフライン対応（下書き保存）

---

## 🚀 推奨される実装順序

### Phase 1: 基本機能（MVP）
1. 環境設定（Firebase, Vercel Blob, Vercel KV）
2. データモデル追加・マイグレーション
3. 画像アップロード機能
4. 投稿作成・編集機能
5. タイムライン機能
6. いいね機能
7. コメント機能
8. APIレート制限

### Phase 2: インタラクション機能
1. リポスト機能
2. ブックマーク機能
3. 全文検索機能
4. コメントへのいいね

### Phase 3: 通知機能
1. 通知データモデル
2. Push Notification実装
3. 通知一覧画面

### Phase 4: 安全機能
1. 報告機能
2. ブロック機能

### Phase 5: 拡張機能（将来）
1. オフライン対応（下書き保存）
2. 通知のグルーピング
3. リッチ通知（画像付き）
4. おすすめアルゴリズムの改善

---

## 📋 確定した実装方針

1. ✅ **画像ストレージ**: Vercel Blob Storage
2. ✅ **通知方式**: Firebase Cloud Messaging (Push Notification)
3. ✅ **全文検索**: PostgreSQL pg_trgm拡張（Vercel Neon対応）
4. ✅ **おすすめアルゴリズム**: スコアベースランキング（簡易版）
5. ✅ **APIレート制限**: Vercel KV + @upstash/ratelimit
6. ✅ **画像遅延読み込み**: cached_network_image
7. ✅ **ハッシュタグ正規化**: 英語は小文字、韓国語・日本語はそのまま
8. ✅ **投稿の編集機能**: 24時間以内編集可能

---

## ⚠️ 実装前に対応が必要な項目

1. **データモデルの追加・拡張**:
   - Userモデルに`fcmToken`フィールド追加
   - Postモデルに`isEdited`, `editedAt`, `repostsCount`, `quotesCount`, `quotedPostId`フィールド追加
   - Commentモデルに`likesCount`, `updatedAt`フィールド追加
   - 新規モデル: Repost, Bookmark, Notification, CommentLike, Report, Block

2. **データベースマイグレーション**:
   - Prismaスキーマを更新
   - `npx prisma migrate dev`でマイグレーション実行
   - pg_trgm拡張の有効化

3. **Firebase設定**:
   - Firebase Projectの作成
   - FCM APIキーの取得
   - Flutter・Backendへの設定追加

4. **Vercel Blob設定**:
   - Vercel Blobストレージの有効化
   - 環境変数の設定

---

## 🛠️ 技術スタック

- **Backend**: Next.js 16.0.1 (App Router) + TypeScript 5
- **ORM**: Prisma 6.1.0
- **Database**: PostgreSQL (Vercel Neon)
- **Auth**: Auth0 (JWT検証)
- **Storage**: Vercel Blob Storage
- **Cache/Rate Limit**: Vercel KV
- **Frontend**: Flutter 3.0+ / Dart 3.9.2+
- **State Management**: Riverpod 3.0
- **Push Notification**: Firebase Cloud Messaging

---

## 📝 注意事項

### パフォーマンス最適化
- **N+1問題の回避**: Prismaの`include`を適切に使用
- **インデックスの活用**: `userId`, `createdAt`, `likesCount`等に適切なインデックス
- **画像最適化**: Vercel BlobのCDN活用
- **無限スクロール**: cursor-basedページネーションの使用

### セキュリティ
- **認証**: すべての変更系APIでAuth0 JWT検証
- **認可**: ユーザーは自分の投稿のみ編集・削除可能
- **レート制限**: 適切なレート制限でスパム防止
- **入力検証**: すべての入力データを検証（文字数制限、画像サイズ等）

### テスト
- **単体テスト**: 各API RouteにJestテストを追加
- **統合テスト**: 主要なフローをテスト
- **E2Eテスト**: Flutter Integration Testで主要画面をテスト
