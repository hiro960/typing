# タイピングキーボードの詳細仕様

## 入力方式
### 独自韓国語キーボード実装
- **カスタムキーボードUI**:
  - Flutter上に独自の韓国語キーボードを実装
  - ネイティブキーボードに依存しない（韓国語設定なしでも利用可能）
  - 2-Set Korean配列（標準的な配列）

- **キーボードレイアウト**:
```
┌────────────────────────────────────────┐
│  ㅂ  ㅈ  ㄷ  ㄱ  ㅅ  ㅛ  ㅕ  ㅑ  ㅐ  ㅔ │
│    ㅁ  ㄴ  ㅇ  ㄹ  ㅎ  ㅗ  ㅓ  ㅏ  ㅣ   │
│  ⇧  ㅋ  ㅌ  ㅊ  ㅍ  ㅠ  ㅜ  ㅡ  ⌫      │
│     123   🌐    space    ✓   ⏎       │
└────────────────────────────────────────┘
```

- **入力ロジック**:
  - 子音 + 母音の組み合わせをリアルタイムで処理
  - 複合母音・パッチム（終声）の自動組み立て
  - 例: `ㅇ` + `ㅏ` + `ㄴ` → `안`
  - 例: `ㅇ` + `ㅏ` + `ㄴ` + `ㄴ` → `안` + `ㄴ`（次の文字開始）

- **濃音入力**:
  - Shiftキー + 子音で濃音入力
  - 例: Shift + `ㄱ` → `ㄲ`

### 入力検証ロジック
- **文字単位の検証**:
  - 1文字ずつリアルタイムで正誤判定
  - Unicode正規化（NFC形式）で比較
  - 完全一致のみ正解（部分一致や許容モードなし）
  - 例: `안녕` → `ㅇ`,`ㅏ`,`ㄴ` → `안` → `ㄴ`,`ㅕ`,`ㅇ` → `녕`

---

# カスタム韓国語キーボードUI

## キーボード全体レイアウト
```
┌────────────────────────────────────────┐
│  ㅂ  ㅈ  ㄷ  ㄱ  ㅅ  ㅛ  ㅕ  ㅑ  ㅐ  ㅔ │  ← 第1行（子音・母音）
│    ㅁ  ㄴ  ㅇ  ㄹ  ㅎ  ㅗ  ㅓ  ㅏ  ㅣ   │  ← 第2行（子音・母音）
│  ⇧  ㅋ  ㅌ  ㅊ  ㅍ  ㅠ  ㅜ  ㅡ  ⌫      │  ← 第3行（子音・母音・削除）
│     123   🌐    space    ✓   ⏎       │  ← 第4行（モード切替・スペース・確定・改行）
└────────────────────────────────────────┘
```

## キーの種類とサイズ
- **文字キー**: 40x48px（タップエリア44x52px、マージン含む）
- **Shiftキー（⇧）**: 60x48px
- **削除キー（⌫）**: 60x48px
- **スペースキー**: 200x48px
- **確定キー（✓）**: 60x48px
- **改行キー（⏎）**: 60x48px
- **数字モード切替（123）**: 80x48px
- **言語切替（🌐）**: 60x48px

## キーボードの状態
### 通常モード
- 基本子音・母音の入力

### Shiftモード（濃音入力）
- Shiftキーを押すと濃音モードに切り替え
- 対応する子音キーをタップで濃音入力
  - ㄱ → ㄲ
  - ㄷ → ㄸ
  - ㅂ → ㅃ
  - ㅅ → ㅆ
  - ㅈ → ㅉ
- Shiftキーは青色にハイライト表示

### ヒント機能
- **次に入力すべき文字のハイライト表示**:
  - 次に入力すべき文字のキーの背景色が黄色（#FFD700）に変化
  - 文字が組み立て中の場合（例: `ㅎ` + `ㅏ` → `하`）、次に必要な母音やパッチムをハイライト
  - スペースが必要な場合はスペースキーがハイライト
  - 濃音が必要な場合は、Shiftキーと対応する子音キーの両方がハイライト

- **ハイライトの動作**:
  - ハイライトは常に「次の1つのキー」のみを表示
  - キーをタップすると、次に入力すべきキーが自動的にハイライトされる
  - 不正解のキーをタップしてもハイライトは変わらない

- **視覚的な表現**:
  - 背景色: 黄色（#FFD700）
  - ボーダー: 2px、オレンジ色（#FFA500）でより目立たせる
  - パルスアニメーション: 0.8秒周期でゆっくり明滅（オプション）

### 数字・記号モード（123）
```
┌────────────────────────────────────────┐
│  1  2  3  4  5  6  7  8  9  0         │
│    -  /  :  ;  (  )  $  @  "          │
│  ⇧  .  ,  ?  !  '  #  %  +  ⌫        │
│    ABC   🌐    space    ✓   ⏎        │
└────────────────────────────────────────┘
```

## キー入力時のフィードバック
- **視覚**: キーをタップ時、背景色が一瞬明るくなる（100ms）
- **触覚**: light impact振動
- **音**: タイプライター風のクリック音（オプション）

## 入力候補表示（組み立て中の文字）
```
┌────────────────────────────────────────┐
│  현재 입력: ㅎ + ㅏ + ㄴ → 한          │  ← 組み立て中の文字を表示
├────────────────────────────────────────┤
│  ㅂ  ㅈ  ㄷ  ㄱ  ㅅ  ㅛ  ㅕ  ㅑ  ㅐ  ㅔ │
│    ㅁ  ㄴ  ㅇ  ㄹ  ㅎ  ㅗ  ㅓ  ㅏ  ㅣ   │
│  ⇧  ㅋ  ㅌ  ㅊ  ㅍ  ㅠ  ㅜ  ㅡ  ⌫      │
│     123   🌐    space    ✓   ⏎       │
└────────────────────────────────────────┘
```

## ヒント機能の表示例
ヒント機能がONの場合、次に入力すべきキーが黄色でハイライトされます。

### 例1: 「한국」を入力する場合
**ステップ1**: 最初の文字 `ㅎ` を入力する前
```
┌────────────────────────────────────────┐
│  問題: 한국                            │
│  입力: __                              │
├────────────────────────────────────────┤
│  ㅂ  ㅈ  ㄷ  ㄱ  ㅅ  ㅛ  ㅕ  ㅑ  ㅐ  ㅔ │
│    ㅁ  ㄴ  ㅇ  ㄹ [ㅎ] ㅗ  ㅓ  ㅏ  ㅣ  │  ← ㅎ が黄色でハイライト
│  ⇧  ㅋ  ㅌ  ㅊ  ㅍ  ㅠ  ㅜ  ㅡ  ⌫      │
└────────────────────────────────────────┘
```

**ステップ2**: `ㅎ` を入力後、次は `ㅏ` をハイライト
```
┌────────────────────────────────────────┐
│  問題: 한국                            │
│  입력: ㅎ_                             │
├────────────────────────────────────────┤
│  ㅂ  ㅈ  ㄷ  ㄱ  ㅅ  ㅛ  ㅕ  ㅑ  ㅐ  ㅔ │
│    ㅁ  ㄴ  ㅇ  ㄹ  ㅎ  ㅗ  ㅓ [ㅏ] ㅣ  │  ← ㅏ が黄色でハイライト
│  ⇧  ㅋ  ㅌ  ㅊ  ㅍ  ㅠ  ㅜ  ㅡ  ⌫      │
└────────────────────────────────────────┘
```

**ステップ3**: `ㅏ` を入力後、次は `ㄴ`（パッチム）をハイライト
```
┌────────────────────────────────────────┐
│  問題: 한국                            │
│  입력: 하_                             │
├────────────────────────────────────────┤
│  ㅂ  ㅈ  ㄷ  ㄱ  ㅅ  ㅛ  ㅕ  ㅑ  ㅐ  ㅔ │
│    ㅁ [ㄴ] ㅇ  ㄹ  ㅎ  ㅗ  ㅓ  ㅏ  ㅣ  │  ← ㄴ が黄色でハイライト
│  ⇧  ㅋ  ㅌ  ㅊ  ㅍ  ㅠ  ㅜ  ㅡ  ⌫      │
└────────────────────────────────────────┘
```

**ステップ4**: `ㄴ` を入力後、次は `ㄱ` をハイライト
```
┌────────────────────────────────────────┐
│  問題: 한국                            │
│  입력: 한_                             │
├────────────────────────────────────────┤
│  ㅂ  ㅈ  ㄷ [ㄱ] ㅅ  ㅛ  ㅕ  ㅑ  ㅐ  ㅔ │  ← ㄱ が黄色でハイライト
│    ㅁ  ㄴ  ㅇ  ㄹ  ㅎ  ㅗ  ㅓ  ㅏ  ㅣ  │
│  ⇧  ㅋ  ㅌ  ㅊ  ㅍ  ㅠ  ㅜ  ㅡ  ⌫      │
└────────────────────────────────────────┘
```

### 例2: 濃音「빠르다」の「ㅃ」を入力する場合
濃音が必要な場合は、Shiftキーと子音キーの両方がハイライトされます。
```
┌────────────────────────────────────────┐
│  問題: 빠르다                          │
│  입力: __                              │
├────────────────────────────────────────┤
│ [ㅂ] ㅈ  ㄷ  ㄱ  ㅅ  ㅛ  ㅕ  ㅑ  ㅐ  ㅔ │  ← ㅂ が黄色でハイライト
│    ㅁ  ㄴ  ㅇ  ㄹ  ㅎ  ㅗ  ㅓ  ㅏ  ㅣ  │
│ [⇧] ㅋ  ㅌ  ㅊ  ㅍ  ㅠ  ㅜ  ㅡ  ⌫      │  ← ⇧ も黄色でハイライト
└────────────────────────────────────────┘
※ 「Shift + ㅂ を同時に押してください」のようなメッセージを表示
```

## キーボードのカスタマイズ
- **キーボードテーマ**: ライト/ダーク/カスタム
- **キー音のON/OFF**: 設定画面で切り替え
- **振動のON/OFF**: 設定画面で切り替え
- **キーサイズ**: 小/中/大（アクセシビリティ）
- **ヒント機能のON/OFF**: 設定画面で切り替え
  - デフォルト: ON（初心者向け）
  - レッスン中でもヘッダーの設定ボタンから即座に切り替え可能
  - 設定は次回以降のレッスンにも保持される

---

# タイピング画面

## 画面構成
```
┌─────────────────────────────────┐
│  ← レッスン1: 基本の子音と母音  │  ← ヘッダー（戻るボタン + タイトル）
│  進捗: ███████░░░ 70%          │  ← プログレスバー
├─────────────────────────────────┤
│                                 │
│      問題: 나무                 │  ← 問題文（大きく表示）
│      (나무: 木)                 │  ← 意味表示
│                                 │
│      入力: 나__                 │  ← 入力中の文字
│            ✓✗                   │  ← 正誤インジケーター
│                                 │
├─────────────────────────────────┤
│  スコア: 85点  正解率: 92%     │  ← 統計情報
│  スピード: 45文字/分            │
├─────────────────────────────────┤
│                                 │
│    [カスタム韓国語キーボード]    │  ← キーボード
│                                 │
└─────────────────────────────────┘
```

## ヘッダー
- **戻るボタン**: ← アイコン、タップで確認ダイアログ表示
  - 「レッスンを中断しますか？」→ はい/いいえ
- **レッスンタイトル**: レッスン番号 + タイトル
- **設定ボタン**: ⚙️ アイコン、クイック設定メニュー表示
  - キー音のON/OFF
  - 振動のON/OFF
  - ヒント機能のON/OFF（次に入力すべきキーのハイライト表示）

## プログレスバー
- **進捗率**: パーセンテージ表示（例: 70%）
- **ビジュアル**: グラデーション付きプログレスバー
- **アニメーション**: スムーズに増加

## 問題文エリア
- **問題文**: 28px、Bold、中央揃え
- **意味表示**: 16px、Regular、グレー、括弧付き
- **背景**: 薄いグレー（ライトモード）/ ダークグレー（ダークモード）
- **余白**: 上下24px、左右16px

## 入力エリア
- **入力中の文字**: 28px、等幅フォント
- **カーソル**: 点滅するライン
- **正誤インジケーター**:
  - ✓ 緑色（正解）
  - ✗ 赤色（不正解）

## 統計情報バー
- **スコア**: 現在のポイント
- **正解率**: パーセンテージ
- **スピード**: 文字/分（WPM）
- **レイアウト**: 横並び、均等配置

## リアルタイムフィードバック
### 文字単位フィードバック
- **入力中**: グレーのアンダーライン
- **正解**: 緑色に変化 + チェックマーク(✓) + パルスアニメーション
- **不正解**: 赤色に変化 + バツマーク(✗) + 横揺れアニメーション + 正しい文字を表示

### 単語完了時
- **完璧（ミスなし）**: 「완벽!」アニメーション + キラキラエフェクト
- **良い（1〜2ミス）**: 「좋아!」表示
- **要改善（3ミス以上）**: 「다시 해보세요」+ 再挑戦提案

## レッスン完了画面
```
┌─────────────────────────────────┐
│         🎉 완성! 🎉             │  ← 花吹雪アニメーション
│                                 │
│      レッスン1 完了！           │
│                                 │
│  ┌───────────────────────┐     │
│  │  スコア: 92点          │     │  ← カウントアップアニメーション
│  │  正解率: 95%           │     │
│  │  スピード: 48文字/分   │     │
│  │  所要時間: 8分30秒     │     │
│  └───────────────────────┘     │
│                                 │
│  ┌───────────────────────┐     │
│  │  弱点文字: ㅈ, ㅊ, ㅉ   │     │
│  │  復習をおすすめします   │     │
│  └───────────────────────┘     │
│                                 │
│  [次のレッスン]  [ホームに戻る]  │
└─────────────────────────────────┘
```

---

# 韓国語入力ロジック

## 韓国語文字の構造

韓国語文字（ハングル）は、**初声（子音）+ 中声（母音）+ 終声（子音、オプション）** の3つの要素で構成されます。

```
한 = ㅎ(初声) + ㅏ(中声) + ㄴ(終声)
가 = ㄱ(初声) + ㅏ(中声)
```

## Unicode範囲

- **完成形ハングル**: U+AC00 〜 U+D7A3（11,172文字）
- **Jamo（字母）**:
  - 初声: U+1100 〜 U+1112（19個）
  - 中声: U+1161 〜 U+1175（21個）
  - 終声: U+11A8 〜 U+11C2（27個）

## Jamo組み立てアルゴリズム

### ステップ1: 初声（子音）の入力
```dart
// ユーザーが ㅎ を入力
currentJamo = {
  initial: 'ㅎ',  // 初声
  medial: null,   // 中声（未入力）
  final: null,    // 終声（未入力）
};
// 表示: ㅎ（未完成）
```

### ステップ2: 中声（母音）の入力
```dart
// ユーザーが ㅏ を入力
currentJamo = {
  initial: 'ㅎ',
  medial: 'ㅏ',
  final: null,
};
// 組み立て: ㅎ + ㅏ → 하（完成）
// 表示: 하
```

### ステップ3: 終声（パッチム）の入力
```dart
// ユーザーが ㄴ を入力
currentJamo = {
  initial: 'ㅎ',
  medial: 'ㅏ',
  final: 'ㄴ',
};
// 組み立て: ㅎ + ㅏ + ㄴ → 한（完成）
// 表示: 한
```

### ステップ4: 次の文字の開始
```dart
// ユーザーが ㄱ を入力（子音 = 新しい文字の開始）
// 前の文字を確定
completedText += '한';
// 新しい文字を開始
currentJamo = {
  initial: 'ㄱ',
  medial: null,
  final: null,
};
// 表示: 한ㄱ
```

## Jamo → Unicode変換式

韓国語文字のUnicodeコードポイントは以下の式で計算できます：

```dart
int composeHangul(String initial, String medial, String? final) {
  const int BASE = 0xAC00;  // U+AC00 (가)
  const int MEDIAL_COUNT = 21;
  const int FINAL_COUNT = 28;  // 終声なし(0) + 終声27個

  int initialIndex = getInitialIndex(initial);  // 0〜18
  int medialIndex = getMedialIndex(medial);     // 0〜20
  int finalIndex = final != null ? getFinalIndex(final) : 0;  // 0〜27

  int code = BASE + (initialIndex * MEDIAL_COUNT * FINAL_COUNT)
                  + (medialIndex * FINAL_COUNT)
                  + finalIndex;

  return code;
}

// 例: 한 = ㅎ(18) + ㅏ(0) + ㄴ(4)
// code = 0xAC00 + (18 * 21 * 28) + (0 * 28) + 4
//      = 0xAC00 + 10584 + 0 + 4
//      = 0xD55C (한)
```

## 入力状態マシン

```
[待機] --子音入力--> [初声あり]
  ↑                     ↓ 母音入力
  |                  [初声+中声あり（文字完成）]
  |                     ↓
  |                  分岐:
  |                  ├─ 子音入力 → 終声として追加 or 新文字開始
  |                  └─ 母音入力 → エラー（完成後に母音は続かない）
  |                     ↓
  |                  [初声+中声+終声あり（文字完成）]
  |                     ↓ 子音入力
  +---------------------+ 新文字開始（前文字を確定）
```

## 濃音（ダブル子音）の処理

濃音は **Shift + 子音** で入力します。

| 基本子音 | Shift入力 | 濃音 |
|---------|----------|------|
| ㄱ | Shift + ㄱ | ㄲ |
| ㄷ | Shift + ㄷ | ㄸ |
| ㅂ | Shift + ㅂ | ㅃ |
| ㅅ | Shift + ㅅ | ㅆ |
| ㅈ | Shift + ㅈ | ㅉ |

### 実装例
```dart
String? doubleConsonant(String consonant) {
  const map = {
    'ㄱ': 'ㄲ',
    'ㄷ': 'ㄸ',
    'ㅂ': 'ㅃ',
    'ㅅ': 'ㅆ',
    'ㅈ': 'ㅉ',
  };
  return map[consonant];
}

// Shiftキーがアクティブな状態でㅂをタップ
if (isShiftActive && isConsonant(key)) {
  String? doubled = doubleConsonant(key);
  if (doubled != null) {
    processInput(doubled);
    isShiftActive = false;  // Shiftを解除
  }
}
```

## Unicode正規化（NFC）

入力された文字と正解を比較する際、**NFC形式**に正規化します。

```dart
import 'package:unicode/unicode.dart';

bool isMatch(String input, String expected) {
  String normalizedInput = input.normalize(NormalizationForm.NFC);
  String normalizedExpected = expected.normalize(NormalizationForm.NFC);
  return normalizedInput == normalizedExpected;
}
```

理由:
- ハングルには「合成前」と「合成後」の2つの表現方法がある
- NFCでは「合成後」の形式に統一される
- 例: `한` は `ㅎ + ㅏ + ㄴ`（合成前）と `한`（合成後）の2通りで表現可能