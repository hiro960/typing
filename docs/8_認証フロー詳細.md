# 認証フロー詳細

このドキュメントでは、韓国語タイピングアプリの認証フローとユーザー登録の詳細を説明します。

---

## アーキテクチャ概要

### 基本方針
- **認証**: Auth0（Universal Login）を使用
- **ユーザー管理**: バックエンドDB（PostgreSQL + Prisma）で一元管理
- **Management API**: 使用しない（シンプルさとコスト効率を優先）
- **トークン管理**: アプリ側でAuth0と直接通信

### データフロー
```
[Flutter App] ←→ [Auth0] （認証）
     ↓
[Flutter App] ←→ [Next.js API] ←→ [PostgreSQL] （ユーザーデータ）
```

---

## 初回ユーザー登録フロー

### シーケンス図
```
【ユーザー】      【Flutterアプリ】         【Auth0】         【Next.js API】      【PostgreSQL】
    |                  |                    |                    |                   |
    | ログインボタン     |                    |                    |                   |
    |---------------->|                    |                    |                   |
    |                  |                    |                    |                   |
    |                  | Universal Login起動 |                    |                   |
    |                  |------------------->|                    |                   |
    |                  |                    |                    |                   |
    |  Google/Apple/X  |                    |                    |                   |
    |  を選択して認証    |                    |                    |                   |
    |<---------------------------------->|                    |                   |
    |                  |                    |                    |                   |
    |                  | トークン取得         |                    |                   |
    |                  |<-------------------|                    |                   |
    |                  | (ID/Access/Refresh)|                    |                   |
    |                  |                    |                    |                   |
    |                  | GET /api/users/status                   |                   |
    |                  |-------------------------------------------->|                   |
    |                  |                    |   JWT検証           |                   |
    |                  |                    |<--------------------|                   |
    |                  |                    |                    |                   |
    |                  |                    |     ユーザー検索     |                   |
    |                  |                    |                    |------------------->|
    |                  |                    |                    |<-------------------|
    |                  |                    |                    | (見つからない)      |
    |                  |                    |                    |                   |
    |                  | { registered: false }                   |                   |
    |                  |<--------------------------------------------|                   |
    |                  |                    |                    |                   |
    | プロフィール入力画面表示              |                    |                   |
    |<-----------------|                    |                    |                   |
    |                  |                    |                    |                   |
    | username, displayName等を入力        |                    |                   |
    |---------------->|                    |                    |                   |
    |                  |                    |                    |                   |
    |                  | GET /api/users/check-username?username=xxx                 |
    |                  |-------------------------------------------->|                   |
    |                  |                    |     username検索     |                   |
    |                  |                    |                    |------------------->|
    |                  |                    |                    |<-------------------|
    |                  | { available: true }                     |                   |
    |                  |<--------------------------------------------|                   |
    |                  |                    |                    |                   |
    | 登録ボタンタップ   |                    |                    |                   |
    |---------------->|                    |                    |                   |
    |                  |                    |                    |                   |
    |                  | POST /api/users/setup                   |                   |
    |                  | (username, displayName, bio, etc.)      |                   |
    |                  |-------------------------------------------->|                   |
    |                  |                    |   JWT検証           |                   |
    |                  |                    |<--------------------|                   |
    |                  |                    |                    |                   |
    |                  |                    |     Userレコード作成 |                   |
    |                  |                    |                    |------------------->|
    |                  |                    |                    |<-------------------|
    |                  |                    |                    |                   |
    |                  | UserDetail (作成完了)                   |                   |
    |                  |<--------------------------------------------|                   |
    |                  |                    |                    |                   |
    | ホーム画面へ遷移   |                    |                    |                   |
    |<-----------------|                    |                    |                   |
```

### フローの詳細説明

#### 1. Auth0認証（Authorization Code + PKCE）
1. ユーザーが「ログイン」ボタンをタップ
2. `auth0_flutter` パッケージで Auth0 Universal Login を起動
3. ユーザーがGoogle / Apple / Twitter(X) を選択して認証
4. Auth0からトークンを取得：
   - **IDトークン**: ユーザー情報（sub, email, name等）を含む
   - **アクセストークン**: API呼び出し用（有効期限: 1時間）
   - **リフレッシュトークン**: トークン更新用（有効期限: 30日）
5. トークンを `flutter_secure_storage` に暗号化保存

#### 2. 登録状況確認
1. アプリは `GET /api/users/status` を呼び出し
   - `Authorization: Bearer <accessToken>` ヘッダーを付与
2. バックエンドでJWT検証
3. `auth0UserId` (JWT の `sub` クレーム) でDBを検索
4. レスポンス:
   - **既存ユーザー**: `{ registered: true, user: {...} }` → ホーム画面へ
   - **新規ユーザー**: `{ registered: false }` → プロフィール入力画面へ

#### 3. プロフィール入力
1. アプリがプロフィール入力画面を表示
2. ユーザーが以下を入力：
   - **username**: @username（一意、必須）
   - **displayName**: 表示名（必須）
   - **bio**: 自己紹介（任意）
   - **profileImageUrl**: プロフィール画像URL（任意）

#### 4. Username一意性チェック（リアルタイム）
1. ユーザーがusernameを入力中、リアルタイムで `GET /api/users/check-username?username=xxx` を呼び出し
2. バックエンドでDB検索して重複チェック
3. レスポンス: `{ available: true/false }`
4. アプリ側でバリデーションメッセージを表示

#### 5. ユーザー登録
1. ユーザーが「登録」ボタンをタップ
2. アプリは `POST /api/users/setup` を呼び出し
   - `Authorization: Bearer <accessToken>` ヘッダーを付与
   - ボディ: `{ username, displayName, bio?, profileImageUrl? }`
3. バックエンドでJWT検証
4. バリデーション:
   - `auth0UserId` が既に登録済みでないか確認
   - `username` が一意であることを確認
5. Userレコードを作成:
   - `auth0UserId`: JWT の `sub`
   - `email`: JWT の `email`
   - `username`, `displayName`, `bio`, `profileImageUrl`: リクエストボディから
   - `settings`: デフォルト設定値
6. 作成されたユーザー情報を返却
7. アプリはホーム画面へ遷移

---

## 2回目以降のログインフロー

### シーケンス図
```
【ユーザー】      【Flutterアプリ】         【Auth0】         【Next.js API】
    |                  |                    |                    |
    | ログインボタン     |                    |                    |
    |---------------->|                    |                    |
    |                  |                    |                    |
    |                  | Universal Login起動 |                    |
    |                  |------------------->|                    |
    |                  |                    |                    |
    |  認証（前回と同じプロバイダー）        |                    |
    |<---------------------------------->|                    |
    |                  |                    |                    |
    |                  | トークン取得         |                    |
    |                  |<-------------------|                    |
    |                  |                    |                    |
    |                  | GET /api/users/status                   |
    |                  |-------------------------------------------->|
    |                  | { registered: true, user: {...} }      |
    |                  |<--------------------------------------------|
    |                  |                    |                    |
    | ホーム画面へ遷移   |                    |                    |
    |<-----------------|                    |                    |
```

### フローの詳細説明
1. Auth0認証（同上）
2. `GET /api/users/status` で登録済みを確認
3. 既存ユーザー情報を取得
4. プロフィール入力をスキップし、直接ホーム画面へ

---

## JWT検証の仕組み

### バックエンドでのJWT検証フロー

#### 実装場所
- `backend/src/lib/auth.ts` の `verifyAuth0Token()` 関数

#### 検証手順
1. **トークン抽出**
   - `Authorization` ヘッダーから `Bearer <token>` を取得
   - トークン部分を抽出

2. **JWT検証（jose ライブラリ使用）**
   ```typescript
   import { jwtVerify, createRemoteJWKSet } from 'jose';

   const JWKS = createRemoteJWKSet(
     new URL(`${AUTH0_ISSUER}/.well-known/jwks.json`)
   );

   const { payload } = await jwtVerify(token, JWKS, {
     issuer: AUTH0_ISSUER,
     audience: AUTH0_AUDIENCE,
   });
   ```

3. **検証項目**
   - **署名検証**: Auth0の公開鍵（JWKS）で署名を検証
   - **発行者（Issuer）**: `iss` クレームが `AUTH0_ISSUER` と一致するか
   - **対象者（Audience）**: `aud` クレームが `AUTH0_AUDIENCE` と一致するか
   - **有効期限**: `exp` クレームが現在時刻より後か
   - **発行時刻**: `iat` クレームが現在時刻より前か

4. **ユーザー情報抽出**
   - `sub`: Auth0ユーザーID（例: `auth0|123456`）
   - `email`: メールアドレス
   - `name`: 名前（オプション）

5. **ユーザー取得**
   - `auth0UserId` でDBからUserレコードを取得
   - 存在しない場合は `USER_NOT_REGISTERED` エラー（初回登録用エンドポイント以外）

#### エラーハンドリング
```typescript
try {
  const { payload } = await jwtVerify(token, JWKS, {...});
  // ...
} catch (error) {
  if (error instanceof JWTExpired) {
    throw UNAUTHORIZED('Token has expired');
  }
  if (error instanceof JWTClaimValidationFailed) {
    throw UNAUTHORIZED('Invalid token claims');
  }
  throw UNAUTHORIZED('Invalid token');
}
```

### トークンリフレッシュ

#### アプリ側での実装
```dart
// Flutter側（auth0_flutter使用）
final credentials = await auth0.credentialsManager.renewCredentials();
// 新しいアクセストークンとリフレッシュトークンを取得
```

#### 実装タイミング
- アクセストークン有効期限切れ（401エラー）を検知した際
- アプリ起動時（有効期限が近い場合）

#### リフレッシュフロー
1. アプリがAuth0のトークンエンドポイントに直接リクエスト
2. リフレッシュトークンを送信
3. Auth0が新しいアクセストークン + リフレッシュトークンを返却
4. アプリが新しいトークンを保存
5. **バックエンドは関与しない**（Auth0と直接通信）

---

## API仕様

### POST /api/users/setup

#### 目的
初回ユーザー登録（Auth0認証後）

#### 認証
必須（JWT）

#### リクエスト
```http
POST /api/users/setup HTTP/1.1
Authorization: Bearer <accessToken>
Content-Type: application/json

{
  "username": "hanako123",
  "displayName": "はなこ",
  "bio": "韓国語勉強中です！",
  "profileImageUrl": "https://example.com/avatar.jpg"
}
```

**フィールド**:
- `username` (string, 必須): ユーザー名（@なし、3〜20文字、英数字とアンダースコアのみ）
- `displayName` (string, 必須): 表示名（1〜50文字）
- `bio` (string, 任意): 自己紹介（最大160文字）
- `profileImageUrl` (string, 任意): プロフィール画像URL

#### レスポンス

**成功（201 Created）**:
```json
{
  "id": "usr_abc123",
  "auth0UserId": "auth0|123456",
  "username": "hanako123",
  "displayName": "はなこ",
  "email": "hanako@example.com",
  "profileImageUrl": "https://example.com/avatar.jpg",
  "bio": "韓国語勉強中です！",
  "learningLevel": "beginner",
  "followersCount": 0,
  "followingCount": 0,
  "postsCount": 0,
  "createdAt": "2025-01-15T10:00:00.000Z"
}
```

**エラー**:
- `400 Bad Request`: バリデーションエラー
  ```json
  {
    "error": {
      "code": "INVALID_INPUT",
      "message": "Username must be 3-20 characters"
    }
  }
  ```

- `401 Unauthorized`: トークン無効
  ```json
  {
    "error": {
      "code": "UNAUTHORIZED",
      "message": "Invalid or expired token"
    }
  }
  ```

- `409 Conflict`: username既に使用中、または既に登録済み
  ```json
  {
    "error": {
      "code": "CONFLICT",
      "message": "Username already taken"
    }
  }
  ```
  ```json
  {
    "error": {
      "code": "CONFLICT",
      "message": "User already registered"
    }
  }
  ```

---

### GET /api/users/check-username

#### 目的
Username可用性のリアルタイムチェック

#### 認証
不要（公開エンドポイント）

#### リクエスト
```http
GET /api/users/check-username?username=hanako123 HTTP/1.1
```

**クエリパラメータ**:
- `username` (string, 必須): チェックするユーザー名

#### レスポンス

**成功（200 OK）**:
```json
{
  "available": true
}
```
```json
{
  "available": false
}
```

**エラー**:
- `400 Bad Request`: username未指定またはフォーマット不正
  ```json
  {
    "error": {
      "code": "INVALID_INPUT",
      "message": "Username is required"
    }
  }
  ```

---

### GET /api/users/status

#### 目的
現在のユーザーの登録状況確認

#### 認証
必須（JWT）

#### リクエスト
```http
GET /api/users/status HTTP/1.1
Authorization: Bearer <accessToken>
```

#### レスポンス

**成功（200 OK） - 登録済み**:
```json
{
  "registered": true,
  "user": {
    "id": "usr_abc123",
    "auth0UserId": "auth0|123456",
    "username": "hanako123",
    "displayName": "はなこ",
    "email": "hanako@example.com",
    "profileImageUrl": "https://example.com/avatar.jpg",
    "bio": "韓国語勉強中です！",
    "learningLevel": "beginner",
    "followersCount": 0,
    "followingCount": 0,
    "postsCount": 0,
    "createdAt": "2025-01-15T10:00:00.000Z"
  }
}
```

**成功（200 OK） - 未登録**:
```json
{
  "registered": false
}
```

**エラー**:
- `401 Unauthorized`: トークン無効
  ```json
  {
    "error": {
      "code": "UNAUTHORIZED",
      "message": "Invalid or expired token"
    }
  }
  ```

---

## エラーハンドリング

### エラーコード一覧

| コード | HTTP Status | 説明 | 対処方法 |
|--------|-------------|------|----------|
| `INVALID_INPUT` | 400 | バリデーションエラー | 入力内容を修正 |
| `UNAUTHORIZED` | 401 | 認証エラー（トークン無効/期限切れ） | トークンリフレッシュまたは再ログイン |
| `FORBIDDEN` | 403 | 権限エラー | アクセス権限を確認 |
| `NOT_FOUND` | 404 | リソースが見つからない | URLやIDを確認 |
| `CONFLICT` | 409 | リソース競合（username重複等） | 別の値を使用 |
| `UNPROCESSABLE` | 422 | 処理不可能なエンティティ | データ形式を確認 |
| `INTERNAL_ERROR` | 500 | サーバーエラー | 時間をおいて再試行 |

### アプリ側でのエラーハンドリング推奨実装

```dart
try {
  final response = await api.post('/users/setup', data: {...});
  // 成功処理
} on UnauthorizedException {
  // トークンリフレッシュを試行
  await auth0.credentialsManager.renewCredentials();
  // 再試行
} on ConflictException catch (e) {
  if (e.message.contains('Username')) {
    // username重複エラー表示
    showError('このユーザー名は既に使用されています');
  } else {
    // 既に登録済みエラー
    showError('既に登録済みです');
  }
} on ValidationException catch (e) {
  // バリデーションエラー表示
  showError(e.message);
} catch (e) {
  // その他のエラー
  showError('エラーが発生しました。時間をおいて再試行してください。');
}
```

---

## セキュリティ考慮事項

### トークン管理
- ✅ **暗号化保存**: `flutter_secure_storage` で暗号化
- ✅ **HTTPSのみ**: 通信は全てTLS 1.3で暗号化
- ✅ **短い有効期限**: アクセストークンは1時間
- ✅ **リフレッシュトークンローテーション**: 使用後に新しいトークンを発行

### レート制限（将来実装）
- ログイン試行: 5回/10分
- API呼び出し: 100回/分（ユーザーごと）
- Username重複チェック: 10回/分（IPごと）

### データ保護
- ✅ **Prismaの自動エスケープ**: SQLインジェクション対策
- ✅ **入力バリデーション**: 全てのエンドポイントで実施
- ✅ **最小権限原則**: ユーザーは自分のデータのみアクセス可能

---

## 環境変数

### 必須の環境変数

```bash
# Auth0（JWT検証用）
AUTH0_ISSUER_BASE_URL="https://your-tenant.us.auth0.com"
AUTH0_AUDIENCE="https://api.korean-typing.app"

# Database
DATABASE_URL="postgresql://user:password@host:5432/dbname"
```

### 環境変数の説明

- **AUTH0_ISSUER_BASE_URL**: Auth0テナントのベースURL
  - JWT の `iss` クレーム検証に使用
  - JWKS取得にも使用（`{ISSUER}/.well-known/jwks.json`）

- **AUTH0_AUDIENCE**: APIの識別子
  - JWT の `aud` クレーム検証に使用
  - Auth0ダッシュボードで設定したAPI Identifier

- **DATABASE_URL**: PostgreSQL接続文字列
  - Neon（Vercel統合）を推奨

---

## テスト戦略

### 単体テスト

#### JWT検証テスト (`lib/auth.test.ts`)
- ✅ 有効なトークンで検証成功
- ✅ 期限切れトークンでエラー
- ✅ 不正な署名でエラー
- ✅ 不正なIssuerでエラー
- ✅ 不正なAudienceでエラー

#### ユーザー登録テスト (`api/users/setup/route.test.ts`)
- ✅ 有効なデータで登録成功
- ✅ username重複でエラー
- ✅ 既に登録済みでエラー
- ✅ バリデーションエラー（username不正、displayName空等）
- ✅ 認証なしでエラー

#### Username重複チェックテスト (`api/users/check-username/route.test.ts`)
- ✅ 利用可能なusernameで `available: true`
- ✅ 既存のusernameで `available: false`
- ✅ username未指定でエラー
- ✅ 不正なフォーマットでエラー

#### 登録状況確認テスト (`api/users/status/route.test.ts`)
- ✅ 登録済みユーザーで `registered: true` + ユーザー情報
- ✅ 未登録ユーザーで `registered: false`
- ✅ 認証なしでエラー

### 統合テスト
- Auth0 → バックエンド → DBの一連のフロー
- トークンリフレッシュフロー

### E2Eテスト
- 初回ログイン〜プロフィール登録〜ホーム画面表示
- 2回目以降のログイン〜ホーム画面表示

---

## トラブルシューティング

### よくある問題と解決策

#### 1. `UNAUTHORIZED: Invalid or expired token`
**原因**: トークンの有効期限切れまたは不正なトークン

**解決策**:
1. トークンリフレッシュを試行
2. それでも失敗する場合は再ログイン

#### 2. `CONFLICT: Username already taken`
**原因**: 指定したusernameが既に使用されている

**解決策**:
1. 別のusernameを選択
2. リアルタイムチェックAPIを使用して事前確認

#### 3. `CONFLICT: User already registered`
**原因**: 同じAuth0ユーザーIDで既に登録済み

**解決策**:
1. `GET /api/users/status` で現在の状態を確認
2. 既に登録済みの場合はプロフィール編集を使用

#### 4. JWT検証に失敗する
**原因**: 環境変数の設定ミス

**解決策**:
1. `AUTH0_ISSUER_BASE_URL` が正しいか確認
2. `AUTH0_AUDIENCE` がAuth0ダッシュボードの設定と一致するか確認
3. Auth0テナントで該当APIが有効化されているか確認

---

## 今後の拡張予定

### Phase 2: レート制限実装
- Upstash Redisを使用したレート制限
- エンドポイントごとに異なる制限値を設定

### Phase 3: 多要素認証（MFA）
- Auth0のMFA機能を有効化
- SMS / Authenticator Appによる2段階認証

### Phase 4: ソーシャルログイン拡張
- 追加プロバイダー（LINE、Kakao等）の検討
- 複数プロバイダーのアカウント統合

---

## まとめ

### 実装のポイント
1. ✅ **Auth0で認証、DBでユーザー管理**を明確に分離
2. ✅ **Management API不使用**でシンプルな構成
3. ✅ **JWT検証はバックエンドで厳格に実施**
4. ✅ **初回登録時のみ専用エンドポイント使用**
5. ✅ **リアルタイムバリデーション**でUX向上

### 参考リンク
- [Auth0 Flutter SDK](https://github.com/auth0/auth0-flutter)
- [Auth0 JWT Validation](https://auth0.com/docs/secure/tokens/json-web-tokens/validate-json-web-tokens)
- [Prisma Best Practices](https://www.prisma.io/docs/guides/performance-and-optimization)
- [Next.js App Router API Routes](https://nextjs.org/docs/app/building-your-application/routing/route-handlers)
