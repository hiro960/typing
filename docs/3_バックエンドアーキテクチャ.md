# バックエンドアーキテクチャ

## プロジェクト構成
```
korean-typing-app/
├── frontend/                    # Flutterアプリ
│   ├── lib/
│   ├── pubspec.yaml
│   └── ...
├── backend/                     # Next.jsバックエンド
│   ├── pages/
│   │   ├── api/                 # API Routes
│   │   │   ├── auth/
│   │   │   │   └── [...nextauth].ts
│   │   │   ├── users/
│   │   │   │   ├── index.ts
│   │   │   │   └── [id].ts
│   │   │   ├── posts/
│   │   │   │   ├── index.ts
│   │   │   │   ├── [id].ts
│   │   │   │   └── create.ts
│   │   │   ├── lessons/
│   │   │   │   ├── index.ts
│   │   │   │   └── complete.ts
│   │   │   └── health.ts
│   │   └── index.tsx            # ランディングページ（オプション）
│   ├── prisma/
│   │   ├── schema.prisma
│   │   └── migrations/
│   ├── lib/
│   │   ├── prisma.ts            # Prismaクライアント
│   │   ├── auth.ts              # NextAuth設定
│   │   └── utils.ts
│   ├── middleware.ts            # ミドルウェア
│   ├── next.config.js
│   ├── package.json
│   └── tsconfig.json
└── docs/                        # ドキュメント
```

## API Routes構成
### 認証 (/api/auth)
- `POST /api/auth/signin` - ログイン
- `POST /api/auth/signout` - ログアウト
- `GET /api/auth/session` - セッション取得
- `GET /api/auth/csrf` - CSRFトークン取得

### ユーザー (/api/users)
- `GET /api/users` - ユーザー一覧取得（検索）
- `GET /api/users/[id]` - ユーザー詳細取得
- `PUT /api/users/[id]` - ユーザー情報更新
- `DELETE /api/users/[id]` - ユーザー削除
- `GET /api/users/[id]/posts` - ユーザーの投稿一覧
- `GET /api/users/[id]/stats` - ユーザーの統計情報

### 投稿 (/api/posts)
- `GET /api/posts` - 投稿一覧取得（フィード）
- `POST /api/posts` - 新規投稿作成
- `GET /api/posts/[id]` - 投稿詳細取得
- `PUT /api/posts/[id]` - 投稿更新
- `DELETE /api/posts/[id]` - 投稿削除
- `POST /api/posts/[id]/like` - いいね追加
- `DELETE /api/posts/[id]/like` - いいね削除
- `GET /api/posts/[id]/comments` - コメント一覧取得
- `POST /api/posts/[id]/comments` - コメント追加

### レッスン (/api/lessons)
- `GET /api/lessons` - レッスン一覧取得
- `GET /api/lessons/[id]` - レッスン詳細取得
- `POST /api/lessons/complete` - レッスン完了記録
- `GET /api/lessons/stats` - 学習統計取得

### フォロー (/api/follows)
- `POST /api/follows` - フォローする
- `DELETE /api/follows/[id]` - フォロー解除
- `GET /api/follows/followers` - フォロワー一覧
- `GET /api/follows/following` - フォロー中一覧

## ミドルウェア
### 認証ミドルウェア
```typescript
// middleware.ts
import { withAuth } from 'next-auth/middleware';

export default withAuth({
  callbacks: {
    authorized: ({ token, req }) => {
      // 保護されたルートの認証チェック
      if (req.nextUrl.pathname.startsWith('/api/posts')) {
        return !!token;
      }
      return true;
    },
  },
});

export const config = {
  matcher: ['/api/posts/:path*', '/api/users/:path*'],
};
```

### レート制限
```typescript
// lib/rate-limit.ts
import { Redis } from '@upstash/redis';

const redis = Redis.fromEnv();

export async function rateLimit(
  identifier: string,
  limit: number,
  window: number
) {
  const key = `rate-limit:${identifier}`;
  const count = await redis.incr(key);

  if (count === 1) {
    await redis.expire(key, window);
  }

  return count <= limit;
}
```

### エラーハンドリング
```typescript
// lib/error-handler.ts
import { NextApiResponse } from 'next';

export class ApiError extends Error {
  constructor(
    public statusCode: number,
    public message: string
  ) {
    super(message);
  }
}

export function handleError(error: unknown, res: NextApiResponse) {
  if (error instanceof ApiError) {
    return res.status(error.statusCode).json({
      error: error.message,
    });
  }

  console.error('Unexpected error:', error);
  return res.status(500).json({
    error: 'Internal server error',
  });
}
```

## データベース設計（Prisma Schema）
```prisma
// prisma/schema.prisma
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                      String    @id @default(cuid())
  username                String    @unique
  displayName             String
  email                   String    @unique
  profileImageUrl         String?
  bio                     String?
  learningLevel           String    @default("beginner")
  totalLessonsCompleted   Int       @default(0)
  totalPracticeTime       Int       @default(0)
  maxWPM                  Int       @default(0)
  maxAccuracy             Float     @default(0)
  followersCount          Int       @default(0)
  followingCount          Int       @default(0)
  postsCount              Int       @default(0)
  settings                Json?     // ユーザー設定（通知、表示、タイピング、プライバシー）
  createdAt               DateTime  @default(now())
  updatedAt               DateTime  @updatedAt
  lastLoginAt             DateTime?
  isActive                Boolean   @default(true)
  isBanned                Boolean   @default(false)

  posts                   Post[]
  comments                Comment[]
  likes                   Like[]
  following               Follow[]  @relation("Following")
  followers               Follow[]  @relation("Followers")
  lessonCompletions       LessonCompletion[]
  accounts                Account[]
  sessions                Session[]

  @@index([username])
  @@index([email])
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model Post {
  id          String    @id @default(cuid())
  content     String
  imageUrls   String[]
  visibility  String    @default("public")
  userId      String
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  likesCount  Int       @default(0)
  commentsCount Int     @default(0)

  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  comments    Comment[]
  likes       Like[]

  @@index([userId])
  @@index([createdAt])
}

model Comment {
  id        String   @id @default(cuid())
  content   String
  postId    String
  userId    String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  post      Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([postId])
  @@index([userId])
}

model Like {
  id        String   @id @default(cuid())
  postId    String
  userId    String
  createdAt DateTime @default(now())

  post      Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([postId, userId])
  @@index([userId])
}

model Follow {
  id          String   @id @default(cuid())
  followerId  String
  followingId String
  createdAt   DateTime @default(now())

  follower    User     @relation("Following", fields: [followerId], references: [id], onDelete: Cascade)
  following   User     @relation("Followers", fields: [followingId], references: [id], onDelete: Cascade)

  @@unique([followerId, followingId])
  @@index([followerId])
  @@index([followingId])
}

model Lesson {
  id          String   @id @default(cuid())
  title       String
  description String?
  level       String
  order       Int
  content     Json
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  completions LessonCompletion[]

  @@index([level])
  @@index([order])
}

model LessonCompletion {
  id          String   @id @default(cuid())
  lessonId    String
  userId      String
  wpm         Int
  accuracy    Float
  timeSpent   Int
  completedAt DateTime @default(now())

  lesson      Lesson   @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([lessonId])
  @@index([userId])
  @@index([completedAt])
}
```

## ユーザー設定型定義（TypeScript）
```typescript
// UserのsettingsフィールドのJSON型定義
interface UserSettings {
  // 通知設定
  notifications: {
    push: boolean;
    email: boolean;
    comment: boolean;
    like: boolean;
    follow: boolean;
  };

  // 表示設定
  theme: 'light' | 'dark' | 'auto';
  fontSize: 'small' | 'medium' | 'large';
  language: 'ja' | 'ko' | 'en';

  // タイピング設定
  soundEnabled: boolean;
  hapticEnabled: boolean;
  strictMode: boolean;  // 厳密モード（完全一致のみ）

  // プライバシー設定
  profileVisibility: 'public' | 'followers';
  postDefaultVisibility: 'public' | 'followers' | 'private';
}

// デフォルト設定値
const defaultUserSettings: UserSettings = {
  notifications: {
    push: true,
    email: true,
    comment: true,
    like: true,
    follow: true,
  },
  theme: 'auto',
  fontSize: 'medium',
  language: 'ja',
  soundEnabled: true,
  hapticEnabled: true,
  strictMode: true,
  profileVisibility: 'public',
  postDefaultVisibility: 'public',
};
```

## 環境変数（.env.local）
```bash
# Database
DATABASE_URL="postgresql://user:password@host:5432/dbname"

# NextAuth
NEXTAUTH_URL="http://localhost:3000"
NEXTAUTH_SECRET="your-secret-here"

# OAuth Providers
GOOGLE_CLIENT_ID="your-google-client-id"
GOOGLE_CLIENT_SECRET="your-google-client-secret"
APPLE_ID="your-apple-id"
APPLE_TEAM_ID="your-apple-team-id"
APPLE_PRIVATE_KEY="your-apple-private-key"
TWITTER_CLIENT_ID="your-twitter-client-id"
TWITTER_CLIENT_SECRET="your-twitter-client-secret"

# Vercel Blob
BLOB_READ_WRITE_TOKEN="your-blob-token"

# Redis (Upstash)
UPSTASH_REDIS_REST_URL="your-redis-url"
UPSTASH_REDIS_REST_TOKEN="your-redis-token"

# Pusher
PUSHER_APP_ID="your-pusher-app-id"
PUSHER_KEY="your-pusher-key"
PUSHER_SECRET="your-pusher-secret"
PUSHER_CLUSTER="ap3"

# Sentry (オプション)
SENTRY_DSN="your-sentry-dsn"
```