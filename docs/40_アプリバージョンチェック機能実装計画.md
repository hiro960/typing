# アプリバージョンチェック機能 実装計画

## 概要

アプリ起動時にサーバーから最小バージョンを取得し、現在のバージョンが要件を満たさない場合は強制アップデートダイアログを表示する。

## 要件

| 項目 | 内容 |
|------|------|
| バージョン情報取得 | バックエンドAPIで管理 |
| アップデート方式 | 強制（スキップ不可） |
| iOS Store URL | https://apps.apple.com/jp/app/%E3%83%81%E3%83%A3%E3%83%AC%E3%83%83%E3%82%BF/id6755620321 |
| Android Store URL | https://play.google.com/store/apps/details?id=app.koreantyping.chaletta |

---

## 実装手順

### Phase 1: バックエンド

#### 1. APIエンドポイント作成

- **ファイル**: `backend/src/app/api/app-version/route.ts`
- **メソッド**: `GET /api/app-version`
- **認証**: 不要（アプリ起動時、ログイン前でも確認が必要なため）

**レスポンス形式:**

```typescript
{
  "ios": {
    "minimumVersion": "1.3.0",
    "latestVersion": "1.3.0",
    "storeUrl": "https://apps.apple.com/jp/app/%E3%83%81%E3%83%A3%E3%83%AC%E3%83%83%E3%82%BF/id6755620321"
  },
  "android": {
    "minimumVersion": "1.3.0",
    "latestVersion": "1.3.0",
    "storeUrl": "https://play.google.com/store/apps/details?id=app.koreantyping.chaletta"
  }
}
```

---

### Phase 2: フロントエンド - 依存関係

#### 1. pubspec.yaml に追加

- **ファイル**: `application/pubspec.yaml`

```yaml
dependencies:
  package_info_plus: ^8.0.0
```

#### 2. api_constants.dart に追加

- **ファイル**: `application/lib/core/constants/api_constants.dart`

```dart
// ==================== App Version関連 ====================

/// アプリバージョン情報取得
/// GET /api/app-version
/// 認証不要
static const String appVersion = '/api/app-version';
```

---

### Phase 3: フロントエンド - Feature作成

#### 新規ファイル構成

```
application/lib/features/app_version/
├── data/
│   ├── models/
│   │   └── app_version_info.dart      # モデル定義
│   └── repositories/
│       └── app_version_repository.dart # API通信
└── domain/
    ├── providers/
    │   └── app_version_providers.dart  # Riverpod Provider
    └── services/
        └── version_checker_service.dart # バージョン比較
```

#### 1. モデル定義 (`app_version_info.dart`)

```dart
/// プラットフォーム別のバージョン情報
class PlatformVersionInfo {
  final String minimumVersion;
  final String latestVersion;
  final String storeUrl;

  const PlatformVersionInfo({
    required this.minimumVersion,
    required this.latestVersion,
    required this.storeUrl,
  });

  factory PlatformVersionInfo.fromJson(Map<String, dynamic> json) {
    return PlatformVersionInfo(
      minimumVersion: json['minimumVersion'] as String,
      latestVersion: json['latestVersion'] as String,
      storeUrl: json['storeUrl'] as String,
    );
  }
}

/// GET /api/app-version のレスポンス型
class AppVersionResponse {
  final PlatformVersionInfo ios;
  final PlatformVersionInfo android;

  const AppVersionResponse({required this.ios, required this.android});

  factory AppVersionResponse.fromJson(Map<String, dynamic> json) {
    return AppVersionResponse(
      ios: PlatformVersionInfo.fromJson(json['ios']),
      android: PlatformVersionInfo.fromJson(json['android']),
    );
  }

  PlatformVersionInfo forCurrentPlatform(bool isIOS) {
    return isIOS ? ios : android;
  }
}

/// バージョンチェック状態
class VersionCheckState {
  final bool needsForceUpdate;
  final String? storeUrl;
  final String? minimumVersion;
  final String? currentVersion;

  const VersionCheckState({
    this.needsForceUpdate = false,
    this.storeUrl,
    this.minimumVersion,
    this.currentVersion,
  });

  const VersionCheckState.initial() : this();

  const VersionCheckState.forceUpdate({
    required String storeUrl,
    required String minimumVersion,
    required String currentVersion,
  }) : this(
    needsForceUpdate: true,
    storeUrl: storeUrl,
    minimumVersion: minimumVersion,
    currentVersion: currentVersion,
  );
}
```

#### 2. バージョン比較サービス (`version_checker_service.dart`)

```dart
/// セマンティックバージョン比較サービス
class VersionCheckerService {
  VersionCheckerService._();

  /// バージョン文字列を比較
  /// 戻り値: 負の値(v1<v2), 0(等しい), 正の値(v1>v2)
  static int compareVersions(String v1, String v2) {
    final parts1 = _parseVersion(v1);
    final parts2 = _parseVersion(v2);

    for (int i = 0; i < 3; i++) {
      final p1 = parts1.length > i ? parts1[i] : 0;
      final p2 = parts2.length > i ? parts2[i] : 0;
      if (p1 != p2) return p1 - p2;
    }
    return 0;
  }

  /// バージョン文字列をパース ("1.2.3+4" -> [1, 2, 3])
  static List<int> _parseVersion(String version) {
    final versionOnly = version.split('+').first;
    return versionOnly.split('.').map((p) => int.tryParse(p) ?? 0).toList();
  }

  /// 現在のバージョンが最小バージョン以上かチェック
  static bool isVersionSatisfied(String current, String minimum) {
    return compareVersions(current, minimum) >= 0;
  }
}
```

#### 3. リポジトリ (`app_version_repository.dart`)

- 認証不要の専用Dioインスタンス
- タイムアウト: 5秒（起動体験を損なわないため短めに設定）

#### 4. Provider (`app_version_providers.dart`)

- `versionCheckNotifierProvider`: 状態管理 (keepAlive: true)
- `checkVersion()`: バージョンチェック実行メソッド

---

### Phase 4: フロントエンド - UI

#### 強制アップデートダイアログ

- **ファイル**: `application/lib/ui/widgets/force_update_dialog.dart`

**特徴:**
- `PopScope`で戻るボタン無効化
- `barrierDismissible: false`でバリアタップ無効化
- `url_launcher`でストアを開く
- 重複表示防止ロジック付き

---

### Phase 5: フロントエンド - 統合

#### 1. auth_providers.dart 修正

- **ファイル**: `application/lib/features/auth/domain/providers/auth_providers.dart`
- **修正箇所**: `_tryAutoLogin()` メソッド（Line 133付近）

```dart
Future<void> _tryAutoLogin() async {
  try {
    AppLogger.auth('Trying auto login...');

    // ★ バージョンチェックを最初に実行
    await ref.read(versionCheckNotifierProvider.notifier).checkVersion();

    // 強制アップデートが必要な場合は認証処理を中断
    if (ref.read(versionCheckNotifierProvider).needsForceUpdate) {
      AppLogger.auth('Force update required, stopping auto login');
      return;
    }

    // 以下、既存の認証処理...
    final authRepository = ref.read(authRepositoryProvider);
    final status = await authRepository.tryAutoLogin();
    // ...
  } catch (e) {
    // ...
  }
}
```

#### 2. app_shell.dart 修正

- **ファイル**: `application/lib/ui/shell/app_shell.dart`
- **修正箇所**: `build()` メソッド（Line 27付近）

```dart
@override
Widget build(BuildContext context, WidgetRef ref) {
  final authState = ref.watch(authStateProvider);

  // ★ バージョンチェック状態を監視してダイアログ表示
  ref.listen<VersionCheckState>(
    versionCheckNotifierProvider,
    (previous, next) {
      if (next.needsForceUpdate) {
        WidgetsBinding.instance.addPostFrameCallback((_) {
          ForceUpdateDialogHelper.show(context);
        });
      }
    },
  );

  // 認証状態に応じて画面を切り替え（既存のコード）
  switch (authState.status) {
    // ...
  }
}
```

---

## エラーハンドリング

| ケース | 動作 |
|--------|------|
| オフライン | アプリを使い続けられる（次回起動時に再チェック） |
| APIエラー | アプリを使い続けられる（次回起動時に再チェック） |
| タイムアウト | 4秒でスキップ、アプリを使い続けられる |

---

## 画面遷移フロー

```
アプリ起動
    ↓
_LoadingScreen表示
    ↓
バージョンチェックAPI呼び出し (/api/app-version)
    ↓
┌─────────────────────────────────────┐
│                                     │
▼                                     ▼
[バージョンOK]                    [要アップデート]
    ↓                                 ↓
認証処理へ                      強制アップデートダイアログ
    ↓                                 ↓
通常フロー                      「ストアでアップデート」ボタン
                                      ↓
                                ストアへ遷移
```

---

## 修正対象ファイル一覧

| ファイル | 変更内容 |
|----------|----------|
| `backend/src/app/api/app-version/route.ts` | 新規作成 |
| `application/pubspec.yaml` | package_info_plus追加 |
| `application/lib/core/constants/api_constants.dart` | エンドポイント追加 |
| `application/lib/features/app_version/data/models/app_version_info.dart` | 新規作成 |
| `application/lib/features/app_version/data/repositories/app_version_repository.dart` | 新規作成 |
| `application/lib/features/app_version/domain/services/version_checker_service.dart` | 新規作成 |
| `application/lib/features/app_version/domain/providers/app_version_providers.dart` | 新規作成 |
| `application/lib/ui/widgets/force_update_dialog.dart` | 新規作成 |
| `application/lib/features/auth/domain/providers/auth_providers.dart` | バージョンチェック呼び出し追加 |
| `application/lib/ui/shell/app_shell.dart` | ダイアログ表示ロジック追加 |

---

## 将来の拡張性

- バージョン情報をDBで管理（管理画面から変更可能に）
- 任意アップデート通知機能（スキップ可能なダイアログ）
- リリースノートの表示
- A/Bテストによる段階的ロールアウト
