# 漢字語クイズゲーム実装計画

## 概要

漢字（ハンチャ）の韓国語読みを1文字ずつ選択式で回答するクイズゲーム機能を実装します。

## ゲームの流れ

```
┌─────────────────────────────────────┐
│           問題                       │
│                                     │
│          傳統                        │  ← 漢字（hanja）
│          伝統                        │  ← 意味（meaning）
│                                     │
│    ここに回答が表示される             │  ← 入力済みの文字
│    [ 전 ]                            │
│                                     │
│    ┌───┐ ┌───┐ ┌───┐              │
│    │ 잰 │ │ 전 │ │ 젠 │  ← 1文字目の選択肢
│    └───┘ └───┘ └───┘              │
│    ┌───┐ ┌───┐ ┌───┐              │
│    │ 댄 │ │ 던 │ │ 덴 │              │
│    └───┘ └───┘ └───┘              │
└─────────────────────────────────────┘
```

## 機能仕様

### 0. ゲーム開始画面

- 問題数を選択：**10問** / **20問** / **50問**
- 選択後にゲーム開始

```
┌─────────────────────────────────────┐
│        漢字語クイズ                  │
│                                     │
│   問題数を選んでください             │
│                                     │
│   ┌──────────┐                     │
│   │  10問    │                     │
│   └──────────┘                     │
│   ┌──────────┐                     │
│   │  20問    │                     │
│   └──────────┘                     │
│   ┌──────────┐                     │
│   │  50問    │                     │
│   └──────────┘                     │
│                                     │
│   覚えた漢字語: 15 / 200             │
└─────────────────────────────────────┘
```

### 1. 出題

- `assets/hanja/words/` 配下のJSONデータからランダムに出題
- 覚えた漢字語は出題から除外
- 問題表示：漢字（hanja）+ 意味（meaning）
- **問題表示時にword（韓国語読み）を自動音声再生**

### 2. 回答方式

- 各漢字に対応する韓国語読みを1文字ずつ選択
- 選択肢は6つ（2行×3列のグリッド）
- 選択肢には正解1つ + 紛らわしい音の文字5つ

### 3. 正解時の挙動

- 正解した文字を回答欄に表示
- 次の文字の選択肢を表示
- 全文字正解で「正解！」を表示
- 「覚えた」ボタンを表示
- 「次の問題へ」ボタンを表示

### 4. 不正解時の挙動

- 正解を表示
- 「次の問題へ」ボタンを表示

### 5. 覚えた機能

- 「覚えた」ボタンを押すと、その漢字語を記録
- 覚えた漢字語は今後の出題から除外
- 覚えた漢字語一覧を閲覧可能

## 紛らわしい音の選択肢生成ロジック

韓国語の文字（ハングル）は初声・中声・終声の組み合わせで構成されます。

### 類似音のパターン

```dart
// 初声（子音）の類似グループ
const similarInitials = {
  'ㄱ': ['ㅋ', 'ㄲ'],  // g/k
  'ㄷ': ['ㅌ', 'ㄸ'],  // d/t
  'ㅂ': ['ㅍ', 'ㅃ'],  // b/p
  'ㅈ': ['ㅊ', 'ㅉ'],  // j/ch
  'ㅅ': ['ㅆ'],        // s/ss
};

// 中声（母音）の類似グループ
const similarVowels = {
  'ㅏ': ['ㅐ', 'ㅑ'],  // a/ae/ya
  'ㅓ': ['ㅔ', 'ㅕ'],  // eo/e/yeo
  'ㅗ': ['ㅛ', 'ㅜ'],  // o/yo/u
  'ㅜ': ['ㅠ', 'ㅗ'],  // u/yu/o
  'ㅡ': ['ㅣ', 'ㅜ'],  // eu/i/u
};
```

### 選択肢生成アルゴリズム

1. 正解の文字を初声・中声・終声に分解
2. 以下の方法で紛らわしい文字を5つ生成：
   - 類似初声 + 同じ中声 + 同じ終声（2つ）
   - 同じ初声 + 類似中声 + 同じ終声（2つ）
   - ランダムに異なる文字（1つ）
3. 正解を含めてシャッフル

## データ構造

### 既存データ（HanjaWord）

```json
{
  "id": "word_1001",
  "word": "교육",           // 韓国語での単語
  "hanja": "敎育",          // 漢字
  "meaning": "教育",        // 日本語での意味
  "pronunciation": "교육",  // 発音
  "components": [
    {"character": "敎", "korean": "교", "meaning": "教える"},
    {"character": "育", "korean": "육", "meaning": "育てる"}
  ]
}
```

### ゲーム状態（新規作成）

```dart
/// クイズ設定
enum QuizQuestionCount {
  ten(10),
  twenty(20),
  fifty(50);

  const QuizQuestionCount(this.value);
  final int value;
}

/// 漢字語クイズのゲーム状態
class HanjaQuizState {
  final QuizQuestionCount questionCount;  // 選択された問題数
  final List<HanjaWord> questions;        // 出題する問題リスト
  final int currentQuestionIndex;         // 現在の問題番号（0始まり）
  final HanjaWord currentWord;            // 現在の問題
  final int currentCharIndex;             // 現在回答中の文字インデックス
  final List<String> answeredChars;       // 回答済みの文字
  final List<String> choices;             // 現在の選択肢
  final bool isCorrect;                   // 正解かどうか
  final bool isWordComplete;              // 現在の単語の全文字回答完了か
  final bool isGameComplete;              // 全問題完了か
  final int correctCount;                 // 正解数
  final int wrongCount;                   // 不正解数
  final List<QuizAnswerRecord> answerHistory;  // 回答履歴（結果画面用）
}

/// 各問題の回答記録
class QuizAnswerRecord {
  final HanjaWord word;      // 出題された単語
  final bool isCorrect;      // 正解したか
  final bool isMastered;     // 覚えた済みか
}

/// 覚えた漢字語の記録
class MasteredHanjaWord {
  final String wordId;
  final DateTime masteredAt;
}
```

## ファイル構成

### 新規作成ファイル

```
application/lib/
├── features/hanja_quiz/
│   ├── data/
│   │   ├── models/
│   │   │   └── hanja_quiz_models.dart       # クイズ関連モデル
│   │   ├── repositories/
│   │   │   └── hanja_quiz_repository.dart   # 覚えた記録の永続化
│   │   └── services/
│   │       └── confusing_char_service.dart  # 紛らわしい文字生成
│   ├── domain/
│   │   └── providers/
│   │       └── hanja_quiz_providers.dart    # 状態管理プロバイダー
│   └── presentation/
│       └── widgets/
│           └── hanja_quiz_section.dart      # ホーム画面ゲームタブ用セクション
├── ui/screens/hanja_quiz/
│   ├── hanja_quiz_start_screen.dart         # ゲーム開始画面（問題数選択）
│   ├── hanja_quiz_screen.dart               # メインゲーム画面
│   ├── hanja_quiz_result_screen.dart        # 結果画面
│   └── mastered_words_screen.dart           # 覚えた漢字語一覧
```

### 既存ファイル修正

```
application/lib/ui/screens/home/
└── home_learning_tabs.dart                  # _GamesTabContent に HanjaQuizSection 追加
```

## 実装手順

### Phase 1: 基盤実装

1. **モデル作成** (`hanja_quiz_models.dart`)
   - `HanjaQuizState` - ゲーム状態
   - `HanjaQuizResult` - 回答結果
   - `MasteredHanjaWord` - 覚えた単語記録

2. **紛らわしい文字生成サービス** (`confusing_char_service.dart`)
   - 韓国語文字の分解（初声・中声・終声）
   - 類似音マッピング定義
   - 選択肢生成ロジック

3. **リポジトリ** (`hanja_quiz_repository.dart`)
   - SharedPreferences を使用した覚えた単語の永続化
   - 覚えた単語の追加・削除・取得

### Phase 2: 状態管理

4. **プロバイダー** (`hanja_quiz_providers.dart`)
   - `hanjaQuizProvider` - ゲーム状態管理
   - `masteredWordsProvider` - 覚えた単語管理
   - `availableWordsProvider` - 出題可能な単語リスト

### Phase 3: UI実装

5. **ゲーム開始画面** (`hanja_quiz_start_screen.dart`)
   - 問題数選択ボタン（10問 / 20問 / 50問）
   - 覚えた漢字語数の表示
   - 覚えた漢字語一覧へのリンク

6. **メインゲーム画面** (`hanja_quiz_screen.dart`)
   - 進捗表示（例: 3 / 10）
   - 問題表示（漢字 + 意味）
   - **問題表示時に`wordAudioServiceProvider`を使用して自動音声再生**
   - 回答欄
   - 選択肢グリッド（2行×3列）
   - 正解/不正解表示
   - 「覚えた」「次の問題へ」ボタン

7. **結果画面** (`hanja_quiz_result_screen.dart`)
   - 正解数 / 総問題数
   - 正答率表示
   - **学習した単語一覧**（正解・不正解を区別して表示）
     - 各単語に「覚えた」ボタン
     - 既に覚えた単語はチェックマーク表示
   - 「もう一度」「ホームへ」ボタン

```
┌─────────────────────────────────────┐
│           結果                       │
│                                     │
│        8 / 10 正解                   │
│        正答率: 80%                   │
│                                     │
│  ───────────────────────────────    │
│  学習した単語                        │
│  ───────────────────────────────    │
│                                     │
│  ○ 敎育 교육 教育      [覚えた]     │
│  ○ 學校 학교 学校      [✓ 済]       │
│  ✕ 傳統 전통 伝統      [覚えた]     │
│  ○ 文化 문화 文化      [覚えた]     │
│  ...                                │
│                                     │
│  ┌──────────┐ ┌──────────┐         │
│  │ もう一度  │ │ ホームへ │         │
│  └──────────┘ └──────────┘         │
└─────────────────────────────────────┘
```

8. **覚えた漢字語一覧** (`mastered_words_screen.dart`)
   - 覚えた漢字語のリスト表示
   - 覚えた記録の解除機能

### Phase 4: 統合

9. **ホーム画面のゲームタブへ追加**

   `home_learning_tabs.dart` の `_GamesTabContent` に漢字語クイズセクションを追加：

   ```dart
   /// ゲームタブのコンテンツ（現在）
   class _GamesTabContent extends StatelessWidget {
     @override
     Widget build(BuildContext context) {
       return const Column(
         children: [
           RankingGameSection(),        // タイピングゲーム
           SizedBox(height: AppSpacing.xl),
           PronunciationGameSection(),  // 発音ゲーム
           SizedBox(height: AppSpacing.xl),
           HanjaQuizSection(),          // ★ 漢字語クイズ（新規追加）
         ],
       );
     }
   }
   ```

10. **漢字語クイズセクションWidget作成**

    `features/hanja_quiz/presentation/widgets/hanja_quiz_section.dart`:
    - 他のゲームセクション（`RankingGameSection`等）と同様のカードUI
    - タップでゲーム開始画面（`HanjaQuizStartScreen`）へ遷移
    - 覚えた漢字語数の表示

    ```
    ┌─────────────────────────────────────┐
    │  🀄 漢字語クイズ                     │
    │                                     │
    │  漢字の韓国語読みを当てよう          │
    │  覚えた単語: 15 / 200               │
    │                                     │
    │              [プレイ →]             │
    └─────────────────────────────────────┘
    ```

11. **ナビゲーション設定**
    - ゲームセクション → 開始画面 → ゲーム画面 → 結果画面

## UI設計

### カラースキーム

- 正解時：緑系（AppColors.success）
- 不正解時：赤系（AppColors.error）
- 選択肢：テーマに沿ったボタンスタイル

### アニメーション

- 選択肢タップ時のフィードバック
- 正解/不正解時のアニメーション
- 次の文字への遷移アニメーション

### レスポンシブ対応

- 選択肢ボタンのサイズ調整
- 漢字表示サイズの調整

## 紛らわしい文字生成の詳細実装

### 韓国語文字のUnicode構造

```dart
/// ハングル文字の分解
class HangulDecomposer {
  // ハングルUnicode範囲: 0xAC00 - 0xD7A3
  static const int hangulBase = 0xAC00;
  static const int initialCount = 19;  // 初声の数
  static const int medialCount = 21;   // 中声の数
  static const int finalCount = 28;    // 終声の数（パッチムなし含む）

  // 初声リスト
  static const initials = [
    'ㄱ', 'ㄲ', 'ㄴ', 'ㄷ', 'ㄸ', 'ㄹ', 'ㅁ', 'ㅂ', 'ㅃ',
    'ㅅ', 'ㅆ', 'ㅇ', 'ㅈ', 'ㅉ', 'ㅊ', 'ㅋ', 'ㅌ', 'ㅍ', 'ㅎ'
  ];

  // 中声リスト
  static const medials = [
    'ㅏ', 'ㅐ', 'ㅑ', 'ㅒ', 'ㅓ', 'ㅔ', 'ㅕ', 'ㅖ', 'ㅗ', 'ㅘ',
    'ㅙ', 'ㅚ', 'ㅛ', 'ㅜ', 'ㅝ', 'ㅞ', 'ㅟ', 'ㅠ', 'ㅡ', 'ㅢ', 'ㅣ'
  ];

  // 終声リスト（0番目は終声なし）
  static const finals = [
    '', 'ㄱ', 'ㄲ', 'ㄳ', 'ㄴ', 'ㄵ', 'ㄶ', 'ㄷ', 'ㄹ', 'ㄺ',
    'ㄻ', 'ㄼ', 'ㄽ', 'ㄾ', 'ㄿ', 'ㅀ', 'ㅁ', 'ㅂ', 'ㅄ', 'ㅅ',
    'ㅆ', 'ㅇ', 'ㅈ', 'ㅊ', 'ㅋ', 'ㅌ', 'ㅍ', 'ㅎ'
  ];

  /// 文字を初声・中声・終声に分解
  static (int, int, int)? decompose(String char) {
    if (char.isEmpty) return null;
    final code = char.codeUnitAt(0);
    if (code < hangulBase || code > 0xD7A3) return null;

    final offset = code - hangulBase;
    final initialIndex = offset ~/ (medialCount * finalCount);
    final medialIndex = (offset % (medialCount * finalCount)) ~/ finalCount;
    final finalIndex = offset % finalCount;

    return (initialIndex, medialIndex, finalIndex);
  }

  /// 初声・中声・終声から文字を合成
  static String compose(int initial, int medial, int final_) {
    final code = hangulBase +
        (initial * medialCount * finalCount) +
        (medial * finalCount) +
        final_;
    return String.fromCharCode(code);
  }
}
```

## データの永続化

### SharedPreferences キー設計

```dart
// 覚えた漢字語のID一覧
static const masteredWordsKey = 'hanja_quiz_mastered_words';

// 保存形式: JSON配列
// ["word_1001", "word_1002", ...]
```

## テスト計画

### ユニットテスト

1. 韓国語文字の分解・合成
2. 紛らわしい文字生成
3. 正解判定ロジック

### 統合テスト

1. ゲームフロー（正解→次の文字→完了）
2. 不正解フロー
3. 覚えた機能の永続化

## 追加検討事項

### 将来的な拡張

- 難易度設定（選択肢数の変更）
- 統計機能（正答率、学習進捗）
- 復習モード（覚えた単語の再テスト）
- カテゴリ別出題
- レベル別出題

### パフォーマンス考慮

- 全単語データのキャッシュ活用（既存のHanjaRepositoryを利用）
- 選択肢生成の最適化

## 参考

- 既存実装: `application/lib/features/ranking_game/` （タイピングゲーム）
- 既存モデル: `application/lib/features/hanja/data/models/hanja_word.dart`
- 既存リポジトリ: `application/lib/features/hanja/data/repositories/hanja_repository.dart`
- 音声再生: `application/lib/features/wordbook/domain/providers/wordbook_providers.dart`
  - `wordAudioServiceProvider` - 韓国語TTS音声再生サービス
  - 使用例: `ref.read(wordAudioServiceProvider.notifier).speak("교육");`
