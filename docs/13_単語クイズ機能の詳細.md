# 単語クイズ機能の詳細仕様

## 概要

単語帳機能に追加される復習用クイズ機能。復習中の単語を使用して、フラッシュカード形式でクイズを実施できる。

## 機能の起動

### クイズボタンの配置

- **配置場所**: 単語帳ページの以下の位置に配置
  - 新規単語追加ボタンの下
  - 単語/文章の切り替えタブの右側
  - 画面の右端

### 起動条件

- クイズボタンを押すと、**全ての復習中単語**を使用してクイズが開始される
- 復習中単語がない場合は、クイズボタンが無効化される

## クイズ画面のUI構成

### 上部エリア

```
┌────────────────────────────────────────┐
│ [← 戻る]              [3/10]          │
├────────────────────────────────────────┤
```

- **左上**: 戻るボタン
  - クイズ途中で押すとクイズ終了画面へ遷移
- **右上**: 進捗表示
  - フォーマット: `現在のカード番号/総カード数`
  - 例: `3/10`

### 中央エリア（カード表示）

```
┌────────────────────────────────────────┐
│                                        │
│         안녕하세요            🔊        │
│                                        │
│         （意味が表示される領域）         │
│                                        │
└────────────────────────────────────────┘
```

- 単語または文章がカード形式で表示される
- 意味は初期状態では非表示
- 「わからない」ボタンを1回押すと意味が表示される
- **音声再生アイコン（🔊）**:
  - カード右上に配置
  - タップすると単語の発音が再生される
  - 単語帳画面と同じ`WordAudioService`を使用

### 下部エリア（操作ボタン）

```
┌──────────────────┬──────────────────┐
│       😫         │       😆         │
│                  │                  │
│   わからない      │     わかる        │
└──────────────────┴──────────────────┘
```

- **わからないボタン**
  - 上部に😫アイコン（`Icons`クラス使用）
  - ボタンラベル: 「わからない」

- **わかるボタン**
  - 上部に😆アイコン（`Icons`クラス使用）
  - ボタンラベル: 「わかる」

## クイズの操作フロー

### 基本操作

#### 1. 「わからない」操作

**パターンA: スワイプ**
- カードを左にスワイプ
- カードが薄い赤色に変化
- わからない扱いで記録
- 次のカードが表示される

**パターンB: ボタン（1回目）**
- 「わからない」ボタンを押す
- 意味が単語/文章の下に表示される
- カードは次に進まない

**パターンB: ボタン（2回目）**
- 意味が表示された状態で再度「わからない」ボタンを押す
- カードが左にスワイプ（薄い赤色に変化）
- わからない扱いで記録
- 次のカードが表示される

#### 2. 「わかる」操作

**パターンA: スワイプ**
- カードを右にスワイプ
- カードが薄い緑色に変化
- わかる扱いで記録
- 次のカードが表示される

**パターンB: ボタン**
- 「わかる」ボタンを押す
- カードが右にスワイプ（薄い緑色に変化）
- わかる扱いで記録
- 次のカードが表示される

### カードの色変化

| 操作 | 色の変化 |
|------|----------|
| 左スワイプ（わからない） | 薄い赤色 |
| 右スワイプ（わかる） | 薄い緑色 |

### 中断操作

- 「戻る」ボタンを押す
- クイズ終了画面へ遷移
- それまでの結果が記録される

## クイズ終了画面

### 遷移条件

- 全ての単語カードを処理し終えた時
- クイズ途中で「戻る」ボタンを押した時

### 画面構成

#### 1. アニメーション

クイズ完了時（全カード処理時）に**Confettiアニメーション**が表示される

```dart
ConfettiWidget(
  confettiController: _confettiController,
  blastDirectionality: BlastDirectionality.explosive,
  blastDirection: 1.5708, // π/2 ラジアン = 下向き
  emissionFrequency: 0.04,
  numberOfParticles: 28,
  maxBlastForce: 12,
  minBlastForce: 5,
  gravity: 0.2,
)
```

#### 2. カード結果一覧

今回めくったカードの一覧が表示される

**各カードの表示内容:**

```
┌────────────────────────────────────────┐
│ 안녕하세요                              │
│ （こんにちは）                          │
│                                        │
│ ステータス: [わかる / わからない]        │
│                                        │
│ [覚えた] ボタン                         │
└────────────────────────────────────────┘
```

- **単語/例文**: 元のテキスト
- **意味**: 日本語の意味
- **ステータス**: 「わかる」または「わからない」の表示
- **「覚えた」ボタン**
  - 押すと復習中単語から外す（マスター状態に変更）
  - APIと連携してステータスを更新
  - 再度復習中単語に戻すこともできる（トグル機能）

#### 3. 操作ボタン

```
┌────────────────────────────────────────┐
│                                        │
│      [もう一度クイズをする]             │
│                                        │
│      [単語帳に戻る]                     │
│                                        │
└────────────────────────────────────────┘
```

- **「もう一度クイズをする」ボタン**
  - 同じ復習中単語セットで新たにクイズを開始
  - カードの順序はシャッフルされる

- **「単語帳に戻る」ボタン**
  - 単語帳ページに戻る
  - 「覚えた」に変更した単語は復習中から除外されている

## データ連携仕様

### クイズ実行中

- 各カードの結果（わかる/わからない）をメモリに保持
- ローカルのみで管理（API連携不要）

### クイズ終了時

- 「覚えた」ボタンを押した時のみAPI連携
- 単語のステータスを「復習中」→「マスター」に更新
- 再度「復習中に戻す」ボタンを押した時は「マスター」→「復習中」に更新

### API仕様（参考）

既存の単語帳API（`/api/wordbook`）を使用

```typescript
// ステータス更新
PATCH /api/wordbook/[id]
{
  "status": "mastered" | "reviewing"
}
```

## 実装上の技術的考慮事項

### 必要なパッケージ

- **confetti**: Confettiアニメーション用
- **flutter_swipe_detector** または **flutter_card_swiper**: カードスワイプ機能用
- **flutter_tts**: 音声再生機能用（単語帳機能ですでに使用中）

### 状態管理

- Riverpod 3.0を使用
- クイズの状態（現在のカード、結果リスト、進捗など）を管理するProviderが必要

### UI実装

- カードのスワイプアニメーション
- カードの色変化アニメーション
- スムーズな画面遷移

### 音声再生機能

- 単語帳機能で実装済みの`WordAudioService`を再利用
- 音声設定（再生速度、音声エンジン）も単語帳と共通
- 共通化のため、以下のように実装を推奨:
  ```dart
  // クイズ画面での使用例
  final audioService = ref.read(wordAudioServiceProvider.notifier);
  await audioService.speak(word.word);
  ```
- 詳細な実装方法は[単語帳機能の詳細 - 6. 音声再生機能](./12_単語帳機能の詳細.md#6-音声再生機能)を参照

## クイズ機能の動作仕様

### 1. 復習中単語が0件の場合

- クイズボタンを無効化する
- ボタンの見た目をグレーアウトさせて、クリックできないことを示す

### 2. クイズの並び順

- 単語はランダムな順序で表示される
- クイズ開始時に復習中単語リストをシャッフルする

### 3. 「もう一度クイズをする」時の挙動

- 復習中単語リストを再度シャッフルする
- 前回と異なる順序でクイズが開始される

### 4. スワイプとボタンの優先度

- **ボタン操作を優先**する
- スワイプジェスチャーよりもボタンタップの方が確実に動作する
- スワイプは補助的な操作方法として実装

### 5. 意味表示のタイミング

- 意味は「わからない」ボタンを押した時のみ表示される
- 「わかる」ボタンを押す前に意味を確認することはできない
- これにより、ユーザーが単語を本当に覚えているかをテストできる

## 関連機能

- [単語帳機能の詳細](./12_単語帳機能の詳細.md)
- [単語帳機能の音声再生](./12_単語帳機能の詳細.md#6-音声再生機能)
- 単語帳のステータス管理
- 単語/文章の表示機能
